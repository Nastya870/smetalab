# üîó Integration Tests

**–°—Ç–∞—Ç—É—Å:** ‚úÖ 26/26 passing (100%)

---

## üìã –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è?

### 1. Auth API (`tests/integration/api/auth.api.test.js`) - 18 —Ç–µ—Å—Ç–æ–≤

#### POST /api/auth/register (5 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Üí 201
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º email ‚Üí 400
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ª–∞–±–æ–º –ø–∞—Ä–æ–ª–µ ‚Üí 400
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥—É–±–ª–∏—Ä—É—é—â–µ–º—Å—è email ‚Üí 409
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è ‚Üí 400

#### POST /api/auth/login (5 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –í—Ö–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ credentials ‚Üí 200
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –ø–∞—Ä–æ–ª–µ ‚Üí 401
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ‚Üí 401
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ email ‚Üí 400
- ‚úÖ JWT payload —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

#### POST /api/auth/refresh (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token –ø–æ refresh token ‚Üí 200
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º refresh token ‚Üí 401
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ refresh token ‚Üí 400

#### POST /api/auth/logout (2 —Ç–µ—Å—Ç–∞)
- ‚úÖ –£—Å–ø–µ—à–Ω—ã–π logout ‚Üí 200
- ‚úÖ –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞ ‚Üí 401

#### GET /api/auth/me (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ‚Üí 200
- ‚úÖ –û—à–∏–±–∫–∞ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Üí 401
- ‚úÖ –û—à–∏–±–∫–∞ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚Üí 403

---

### 2. Roles API (`tests/integration/api/roles.api.test.js`) - 8 —Ç–µ—Å—Ç–æ–≤

#### GET /api/roles (4 —Ç–µ—Å—Ç–∞)
- ‚úÖ Super admin –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏
- ‚úÖ Super admin –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –í–°–ï–ú —Ä–æ–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ super_admin
- ‚úÖ Tenant admin –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ tenant roles —Å–≤–æ–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞

#### GET /api/permissions/roles/:id (1 —Ç–µ—Å—Ç)
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–ª–∏ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏

#### Edge Cases (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –û—à–∏–±–∫–∞ 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –û—à–∏–±–∫–∞ 403 —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
- ‚úÖ –û—à–∏–±–∫–∞ 404 –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–æ–ª–∏

---

## üöÄ –ó–∞–ø—É—Å–∫

### –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
```powershell
npm run test:integration
```

### –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
```powershell
.\test-scripts\integration-tests\scripts\run-integration.ps1
```

### –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```powershell
npx vitest run tests/integration/api/auth.api.test.js
npx vitest run tests/integration/api/roles.api.test.js
```

### –° –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
```powershell
npm run test:integration -- --reporter=verbose
```

---

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –°–µ—Ä–≤–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã
```powershell
# Backend (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
npm run server
# ‚Üí http://localhost:3001

# Frontend (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
npm run dev
# ‚Üí http://localhost:5173
```

**–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –æ–±–æ–∏—Ö:**
```powershell
.\test-scripts\run-servers.ps1
```

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- PostgreSQL (Neon Cloud)
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DATABASE_URL –≤ .env

### 3. Environment variables
```bash
DATABASE_URL=postgresql://...
JWT_SECRET=your-secret-key
```

---

## üßπ Data Isolation

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ email domains:
- **Auth tests:** `@test.com`
- **Roles tests:** `@rolestest.local`

### Cleanup –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```javascript
afterAll(async () => {
  await testDb.cleanupTestData();
  await testDb.closePool();
});
```

---

## üêõ Troubleshooting

### –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π "NO_TENANTS"
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—á–∏—Å—Ç–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
node test-scripts/shared/utilities/list-users.mjs
# –ù–∞–π–¥–∏—Ç–µ @test.com –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É–¥–∞–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL
```

### –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π FK constraint
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ä—è–¥–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `testDatabase.js` ‚Äî cleanup –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ FK –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –û—à–∏–±–∫–∞ "ECONNREFUSED"
**–ü—Ä–∏—á–∏–Ω–∞:** Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```powershell
npm run server
```

---

## üìä Performance

**–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- Auth API tests: ~15-20s
- Roles API tests: ~10-12s
- **Total:** ~28-30s

---

## üéØ –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è

1. ‚úÖ Auth API (18 —Ç–µ—Å—Ç–æ–≤)
2. ‚úÖ Roles API (8 —Ç–µ—Å—Ç–æ–≤)
3. ‚è≥ Works API (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
4. ‚è≥ Materials API (CRUD + import)
5. ‚è≥ Projects API (CRUD + estimates)
6. ‚è≥ Estimates API (—Ä–∞—Å—á—ë—Ç—ã, —ç–∫—Å–ø–æ—Ä—Ç)
7. ‚è≥ Counterparties API
8. ‚è≥ Suppliers API

---

## üìñ –°–º. —Ç–∞–∫–∂–µ

- **[TESTING_GUIDE.md](../../TESTING_GUIDE.md)** ‚Äî –≥–ª–∞–≤–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- **[README_TESTING.md](../../README_TESTING.md)** ‚Äî –¥–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏ 21-22 –Ω–æ—è–±—Ä—è
- **[shared/fixtures/](../../shared/fixtures/)** ‚Äî testDatabase.js
