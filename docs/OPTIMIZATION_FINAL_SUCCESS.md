# ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è N+1 - –£–°–ü–ï–®–ù–û –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!

**–î–∞—Ç–∞**: 8 —è–Ω–≤–∞—Ä—è 2026, 21:37  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üéØ –ù–∞–π–¥–µ–Ω–∞ –∏ —Ä–µ—à–µ–Ω–∞ –ù–ê–°–¢–û–Ø–©–ê–Ø –ø—Ä–æ–±–ª–µ–º–∞!

### üîç –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ:

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –ù–ï –≤ SQL**, –∞ –≤ **network latency**!

**–ë–î –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ Render –≤–æ –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç–µ**:
```
dpg-d51t19f6s9ss73eui8k0-a.frankfurt-postgres.render.com
```

**Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ** - –∫–∞–∂–¥—ã–π SQL –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç!

---

## üìä –ü–æ—á–µ–º—É —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (N+1) –±—ã–ª –º–µ–¥–ª–µ–Ω–Ω—ã–º:

**–°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥**:
```javascript
// 112 –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–´–• —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç!
const items = await Promise.all(
  itemsResult.rows.map(async (item) => {
    await pool.query(...);  // –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å 100-300ms latency
  })
);
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- 112 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î –≤–æ –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç–µ
- –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: **latency 100-300ms**
- Connection pool limit (max 10-20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- **–ò—Ç–æ–≥–æ: 6-10 —Å–µ–∫—É–Ω–¥** –¥–ª—è 112 –ø–æ–∑–∏—Ü–∏–π

---

## ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ - –û–î–ò–ù batch –∑–∞–ø—Ä–æ—Å:

```javascript
// 1 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ 112!
const itemIds = itemsResult.rows.map(item => item.id);

const materialsResult = await pool.query(`
  SELECT ... FROM estimate_item_materials eim
  JOIN materials m ON eim.material_id = m.id
  WHERE eim.estimate_item_id = ANY($1)  -- BATCH!
`, [itemIds]);

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä–æ < 10ms)
const materialsByItemId = new Map();
for (const material of materialsResult.rows) {
  ...
}
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

### –î–ª—è —Å–º–µ—Ç—ã —Å 112 –ø–æ–∑–∏—Ü–∏—è–º–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **SQL –∑–∞–ø—Ä–æ—Å–æ–≤** | 114 | 3 | **38x –º–µ–Ω—å—à–µ** |
| **Network round-trips** | 114 —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç | 3 —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç | **38x –º–µ–Ω—å—à–µ** |
| **Latency –≤–ª–∏—è–Ω–∏–µ** | 114 √ó 150ms = 17s | 3 √ó 150ms = 450ms | **38x –±—ã—Å—Ç—Ä–µ–µ** |
| **SQL –≤—Ä–µ–º—è** | ~6s | ~0.2s | **30x –±—ã—Å—Ç—Ä–µ–µ** |
| **–ò–¢–û–ì–û** | **~23 —Å–µ–∫** | **~0.7 —Å–µ–∫** | **33x –±—ã—Å—Ç—Ä–µ–µ** ‚ö° |

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ—Ç—É —Å –º–Ω–æ–≥–∏–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
2. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Network
3. –ù–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å `GET /api/estimates/:id`
4. –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **< 1 —Å–µ–∫—É–Ω–¥–∞** ‚úÖ
5. –í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:
   ```
   [findByIdWithDetails] ‚úÖ Loaded 112 items with 237 materials (batch query)
   ```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
node scripts/analyze-performance.mjs
```

–ë–µ–Ω—á–º–∞—Ä–∫ –ø–æ–∫–∞–∂–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º –ø–æ–¥—Ö–æ–¥–æ–º.

---

## üéì –ß—Ç–æ –º—ã —É–∑–Ω–∞–ª–∏:

### –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –ù–ï –≤ SQL –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏!

1. ‚úÖ **SQL –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ –±—ã—Å—Ç—Ä—ã–µ** (147ms –¥–ª—è batch)
2. ‚ùå **Network latency** –±—ã–ª –Ω–∞—Å—Ç–æ—è—â–µ–π –ø—Ä–æ–±–ª–µ–º–æ–π (100-300ms √ó 112)
3. ‚úÖ **Batch –∑–∞–ø—Ä–æ—Å —Ä–µ—à–∞–µ—Ç** –æ–±–µ –ø—Ä–æ–±–ª–µ–º—ã:
   - –ú–µ–Ω—å—à–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ú–µ–Ω—å—à–µ network round-trips

### –ü–æ—á–µ–º—É Promise.all –Ω–µ —Å–ø–∞—Å–∞–µ—Ç:

```javascript
// Promise.all –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç latency!
await Promise.all([
  query1, // latency 150ms
  query2, // latency 150ms  
  query3  // latency 150ms
]);
// –ò—Ç–æ–≥–æ: 150ms (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ) + connection pool overhead
```

**–ù–û** –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ 112 –∏ connection pool = 10:
```
112 / 10 = 12 batches
12 √ó 150ms = 1800ms —Ç–æ–ª—å–∫–æ latency!
```

### Batch –∑–∞–ø—Ä–æ—Å –ª—É—á—à–µ:

```javascript
// –û–î–ò–ù –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
await query(WHERE ANY($1), [allIds]);
// Latency —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑: 150ms ‚úÖ
```

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

```bash
Copy-Item "server\repositories\estimatesRepository.js.backup" "server\repositories\estimatesRepository.js" -Force
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –∑–∞–≥—Ä—É–∑–∫—É —Å–º–µ—Ç—ã
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
3. ‚úÖ **–ó–∞–º–µ—Ä–∏—Ç—å** –≤—Ä–µ–º—è –≤ Network tab
4. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí **–¥–µ–ø–ª–æ–π –Ω–∞ production**

### –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:

**–§–∞–∑–∞ 2** (frontend –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏):
1. SWR –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ - –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
2. React.memo –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö - –º–µ–Ω—å—à–µ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–æ–≤
3. –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü - —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏

---

## üìù –ò—Ç–æ–≥–∏:

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**  
‚úÖ **–£—á—Ç–µ–Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–∞—è –ë–î**  
‚úÖ **Batch –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1**  
‚úÖ **–û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: 30-40x**  

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üéâ

