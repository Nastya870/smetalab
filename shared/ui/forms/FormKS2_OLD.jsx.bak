import React from 'react';
import {
  Box,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Grid,
  Divider
} from '@mui/material';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';

// Стили для печати
import '../../styles/printForms.css';

/**
 * Компонент для отображения формы КС-2 
 * (Акт о приемке выполненных работ)
 * ОКУД 0322005
 */
const FormKS2 = ({ data }) => {
  if (!data) {
    return (
      <Box sx={{ p: 3 }}>
        <Typography color="text.secondary">
          Данные формы КС-2 не загружены
        </Typography>
      </Box>
    );
  }

  const formatDate = (date) => {
    if (!date) return '—';
    return format(new Date(date), 'dd.MM.yyyy', { locale: ru });
  };

  const formatCurrency = (amount) => {
    if (amount === null || amount === undefined) return '—';
    return new Intl.NumberFormat('ru-RU', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(amount);
  };

  return (
    <Box className="form-ks2" sx={{ p: 3, bgcolor: 'background.paper' }}>
      {/* Шапка формы */}
      <Box sx={{ mb: 3 }}>
        <Grid container spacing={2}>
          <Grid item xs={6}>
            <Typography variant="caption" color="text.secondary">
              Форма по ОКУД
            </Typography>
            <Typography variant="body2" fontWeight="medium">
              {data.okud || '0322005'}
            </Typography>
          </Grid>
          <Grid item xs={6} sx={{ textAlign: 'right' }}>
            <Typography variant="caption" color="text.secondary">
              от {formatDate(data.actDate)}
            </Typography>
          </Grid>
        </Grid>

        <Typography variant="h6" align="center" sx={{ mt: 2, mb: 1 }}>
          {data.formType || 'АКТ О ПРИЕМКЕ ВЫПОЛНЕННЫХ РАБОТ'}
        </Typography>
        <Typography variant="body2" align="center" color="text.secondary">
          № {data.actNumber || '—'}
        </Typography>
      </Box>

      <Divider sx={{ my: 2 }} />

      {/* Данные контрагентов */}
      <Box sx={{ mb: 3 }}>
        <Grid container spacing={2}>
          {/* Подрядчик */}
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" gutterBottom>
              Подрядчик (Исполнитель)
            </Typography>
            <Typography variant="body2">
              {data.contractor?.name || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              ИНН: {data.contractor?.inn || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              КПП: {data.contractor?.kpp || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              ОГРН: {data.contractor?.ogrn || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              Адрес: {data.contractor?.address || '—'}
            </Typography>
          </Grid>

          {/* Заказчик */}
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" gutterBottom>
              Заказчик
            </Typography>
            <Typography variant="body2">
              {data.customer?.name || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              ИНН: {data.customer?.inn || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              КПП: {data.customer?.kpp || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              ОГРН: {data.customer?.ogrn || '—'}
            </Typography>
            <Typography variant="caption" color="text.secondary" display="block">
              Адрес: {data.customer?.address || '—'}
            </Typography>
          </Grid>
        </Grid>
      </Box>

      <Divider sx={{ my: 2 }} />

      {/* Договор */}
      <Box sx={{ mb: 3 }}>
        <Typography variant="subtitle2" gutterBottom>
          Договор
        </Typography>
        <Typography variant="body2">
          № {data.contract?.number || '—'} от {formatDate(data.contract?.date)}
        </Typography>
        {data.contract?.subject && (
          <Typography variant="caption" color="text.secondary" display="block">
            Предмет: {data.contract.subject}
          </Typography>
        )}
      </Box>

      {/* Объект строительства */}
      <Box sx={{ mb: 3 }}>
        <Typography variant="subtitle2" gutterBottom>
          Объект строительства
        </Typography>
        <Typography variant="body2">
          {data.constructionObject?.name || '—'}
        </Typography>
        {data.constructionObject?.address && (
          <Typography variant="caption" color="text.secondary" display="block">
            Адрес: {data.constructionObject.address}
          </Typography>
        )}
        {data.constructionObject?.okpd && (
          <Typography variant="caption" color="text.secondary" display="block">
            Код по ОКПД2: {data.constructionObject.okpd}
          </Typography>
        )}
      </Box>

      {/* Период выполнения работ */}
      {data.period && (
        <Box sx={{ mb: 3 }}>
          <Typography variant="subtitle2" gutterBottom>
            Период выполнения работ
          </Typography>
          <Typography variant="body2">
            с {formatDate(data.period.from)} по {formatDate(data.period.to)}
          </Typography>
        </Box>
      )}

      <Divider sx={{ my: 2 }} />

      {/* Таблица работ */}
      <TableContainer component={Paper} variant="outlined" sx={{ mb: 3 }}>
        <Table size="small">
          <TableHead>
            <TableRow>
              <TableCell sx={{ fontWeight: 'bold' }}>№</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }}>Код работы</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }}>Наименование работ</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }} align="center">Ед. изм.</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }} align="right">По смете</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }} align="right">Выполнено</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }} align="right">Цена, руб.</TableCell>
              <TableCell sx={{ fontWeight: 'bold' }} align="right">Сумма, руб.</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {data.works && data.works.length > 0 ? (
              data.works.map((work, index) => (
                <TableRow key={work.id || index}>
                  <TableCell>{work.position || index + 1}</TableCell>
                  <TableCell>{work.code || '—'}</TableCell>
                  <TableCell>{work.name}</TableCell>
                  <TableCell align="center">{work.unit || '—'}</TableCell>
                  <TableCell align="right">
                    {formatCurrency(work.plannedQuantity)}
                  </TableCell>
                  <TableCell align="right">
                    {formatCurrency(work.actualQuantity)}
                  </TableCell>
                  <TableCell align="right">
                    {formatCurrency(work.price)}
                  </TableCell>
                  <TableCell align="right">
                    {formatCurrency(work.totalPrice)}
                  </TableCell>
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={8} align="center">
                  <Typography variant="body2" color="text.secondary">
                    Нет данных о выполненных работах
                  </Typography>
                </TableCell>
              </TableRow>
            )}

            {/* Итоговая строка */}
            {data.totals && (
              <TableRow sx={{ bgcolor: 'action.hover' }}>
                <TableCell colSpan={7} sx={{ fontWeight: 'bold' }}>
                  ИТОГО
                </TableCell>
                <TableCell align="right" sx={{ fontWeight: 'bold' }}>
                  {formatCurrency(data.totals.amount)}
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </TableContainer>

      {/* Итоги */}
      {data.totals && (
        <Box sx={{ mb: 3 }}>
          <Typography variant="body2">
            Всего принято работ на сумму: <strong>{formatCurrency(data.totals.amount)} руб.</strong>
          </Typography>
          <Typography variant="body2" color="text.secondary">
            (в том числе НДС, если применимо)
          </Typography>
        </Box>
      )}

      <Divider sx={{ my: 3 }} />

      {/* Подписанты */}
      {data.signatories && data.signatories.length > 0 && (
        <Box sx={{ mb: 3 }}>
          <Typography variant="subtitle2" gutterBottom>
            Подписи
          </Typography>
          <Grid container spacing={3}>
            {data.signatories.map((signatory, index) => (
              <Grid item xs={12} md={6} key={index}>
                <Box sx={{ border: '1px solid', borderColor: 'divider', p: 2, borderRadius: 1 }}>
                  <Typography variant="caption" color="text.secondary" display="block">
                    {getRoleLabel(signatory.role)}
                  </Typography>
                  <Typography variant="body2" fontWeight="medium">
                    {signatory.fullName}
                  </Typography>
                  <Typography variant="caption" color="text.secondary" display="block">
                    {signatory.position}
                  </Typography>
                  {signatory.signedAt && (
                    <Typography variant="caption" color="text.secondary" display="block" sx={{ mt: 1 }}>
                      Подписано: {formatDate(signatory.signedAt)}
                    </Typography>
                  )}
                  <Box sx={{ mt: 2, borderBottom: '1px solid', borderColor: 'divider', width: '60%' }}>
                    <Typography variant="caption" color="text.secondary">
                      Подпись
                    </Typography>
                  </Box>
                </Box>
              </Grid>
            ))}
          </Grid>
        </Box>
      )}

      {/* Примечания */}
      {data.notes && (
        <Box sx={{ mb: 2, p: 2, bgcolor: 'action.hover', borderRadius: 1 }}>
          <Typography variant="caption" color="text.secondary" display="block">
            Примечания
          </Typography>
          <Typography variant="body2">
            {data.notes}
          </Typography>
        </Box>
      )}
    </Box>
  );
};

// Вспомогательная функция для получения названия роли
const getRoleLabel = (role) => {
  const roleLabels = {
    contractor_chief: 'Руководитель подрядчика',
    contractor_accountant: 'Главный бухгалтер подрядчика',
    customer_chief: 'Руководитель заказчика',
    customer_inspector: 'Уполномоченный представитель заказчика',
    technical_supervisor: 'Технический надзор'
  };
  return roleLabels[role] || role;
};

export default FormKS2;
