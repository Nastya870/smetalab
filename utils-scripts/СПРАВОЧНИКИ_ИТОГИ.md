# 📊 Итоговая сводка по системе справочников

## 🎯 Текущее состояние базы данных

### 📚 Справочник РАБОТ (works)

```
Всего записей:     3,371
├─ 🌍 Глобальные:  3,371 (100%)
└─ 🏢 Тенантные:   0 (0%)

Структура: 12 полей
├─ Идентификация: id, code, name
├─ Ценообразование: unit, base_price
├─ Иерархия: phase → section → subsection
├─ Мультитенантность: is_global, tenant_id
└─ Метаданные: created_by, created_at, updated_at
```

**Иерархия работ:**
- 8 уникальных **фаз**
- 77 уникальных **разделов**
- 27 уникальных **подразделов**

---

### 🧱 Справочник МАТЕРИАЛОВ (materials)

```
Всего записей:     46,976
├─ 🌍 Глобальные:  46,976 (100%)
└─ 🏢 Тенантные:   0 (0%)

Структура: ~15 полей
├─ Идентификация: id, sku, name
├─ Ценообразование: price, unit
├─ Классификация: category, supplier
├─ Дополнительно: image, weight, product_url, show_image
├─ Мультитенантность: is_global, tenant_id
└─ Метаданные: created_by, created_at, updated_at
```

---

## 🔄 Архитектура системы

### Двухуровневая модель:

```
┌─────────────────────────────────────────────────────────┐
│                  ГЛОБАЛЬНЫЙ СПРАВОЧНИК                   │
│        🌍 is_global = TRUE, tenant_id = NULL            │
│                                                          │
│  ✅ Доступен всем организациям                          │
│  ✅ Базовый набор (3,371 работ + 46,976 материалов)    │
│  ✅ Редактируют только администраторы                   │
│  ✅ Единая версия для всех                              │
└─────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┴───────────────────┐
        ↓                                       ↓
┌──────────────────────┐            ┌──────────────────────┐
│ ТЕНАНТ 1 (Компания А)│            │ ТЕНАНТ 2 (Компания Б)│
│ 🏢 is_global = FALSE │            │ 🏢 is_global = FALSE │
│   tenant_id = UUID-1 │            │   tenant_id = UUID-2 │
│                      │            │                      │
│ Видят:               │            │ Видят:               │
│ • Глобальные (все)   │            │ • Глобальные (все)   │
│ • Свои тенантные     │            │ • Свои тенантные     │
│                      │            │                      │
│ Могут:               │            │ Могут:               │
│ • Создавать свои     │            │ • Создавать свои     │
│ • Редактировать свои │            │ • Редактировать свои │
│ • Удалять свои       │            │ • Удалять свои       │
└──────────────────────┘            └──────────────────────┘
```

---

## 🎨 UI/UX Фильтрация

### Переключатель типов (ToggleButtonGroup):

```
┌───────────────────────────────────────────────┐
│  [ Все ]  [ 🌍 Глобальные ]  [ 🏢 Мои ]     │
└───────────────────────────────────────────────┘

ВСЕ (all):
  → Показывает: Глобальные + Свои тенантные
  → Файл экспорта: "Экспорт_работ_2025-11-17.csv"
  
ГЛОБАЛЬНЫЕ (global):
  → Показывает: Только is_global = TRUE
  → Файл экспорта: "Экспорт_работ_глобальные_2025-11-17.csv"
  → Для чтения/обзора базового справочника
  
МОИ (tenant):
  → Показывает: Только свои (is_global = FALSE + tenant_id = текущий)
  → Файл экспорта: "Экспорт_работ_мои_2025-11-17.csv"
  → Для управления пользовательскими работами
```

### Визуальные индикаторы:

```
В таблице:
┌────────────────────────────────────────────────┐
│ Код   │ Наименование    │ Тип              │   │
├────────────────────────────────────────────────┤
│ 0-01  │ Демонтаж вытяжки│ 🌍 Глобальная   │   │
│ MY-01 │ Моя работа      │ 🏢 Моя          │   │
└────────────────────────────────────────────────┘

Badges:
  🌍 Глобальная   → Chip primary outlined
  🏢 Моя          → Chip secondary outlined
```

---

## 📥📤 Импорт/Экспорт

### CSV Формат (обновлённый):

```csv
Код;Наименование;Ед изм;Базовая цена;Фаза;Раздел;Подраздел
0-01;Демонтаж вытяжки;шт;380.00;Этап №0;Демонтаж;Бытовая техника
```

**Изменения:**
- ✅ Разделитель: `;` (точка с запятой для Excel)
- ✅ Без кавычек (человекочитаемо)
- ✅ Убрано поле "Категория"
- ✅ Добавлены поля иерархии (Фаза, Раздел, Подраздел)
- ✅ BOM для корректного отображения кириллицы

### Режимы импорта:

```
1. ДОБАВИТЬ (mode: 'add')
   → Добавляет новые записи
   → Пропускает дубликаты по коду
   → Безопасно для докачки данных

2. ЗАМЕНИТЬ (mode: 'replace')
   → Удаляет существующие выбранного типа
   → Загружает новые из CSV
   
   ⚠️ ВАЖНО:
   • При выборе "Глобальные" → удаляются ВСЕ глобальные
   • При выборе "Мои" → удаляются только СВОИ тенантные
```

---

## 🔐 Безопасность (Row Level Security)

### Политики доступа:

```sql
-- SELECT (просмотр):
USING (
  is_global = TRUE OR                    -- Все видят глобальные
  tenant_id = current_tenant_id() OR     -- Видят свои
  is_super_admin()                       -- Админы видят всё
)

-- INSERT (создание):
WITH CHECK (
  (is_global = FALSE AND                 -- Обычные пользователи:
   tenant_id = current_tenant_id()) OR   -- только тенантные
  (is_global = TRUE AND                  -- Админы:
   is_super_admin())                     -- могут глобальные
)

-- UPDATE/DELETE (редактирование/удаление):
USING (
  (is_global = FALSE AND                 -- Свои можно
   tenant_id = current_tenant_id()) OR
  (is_global = TRUE AND                  -- Глобальные только админ
   is_super_admin())
)
```

### Механизм изоляции:

1. **JWT токен** содержит `tenantId` и `userId`
2. **Middleware** извлекает из токена и добавляет в `req.user`
3. **RLS политики** автоматически фильтруют на уровне БД
4. **Невозможно** обойти изоляцию на клиенте

---

## 🚀 API Endpoints

### GET /api/works

```javascript
// Параметры:
?isGlobal=true   // Только глобальные
?isGlobal=false  // Только тенантные
// без параметра  // Все доступные (глобальные + свои)

?search=штукатурка        // Поиск
?phase=Этап+№1            // Фильтр по фазе
?section=Отделочные       // Фильтр по разделу
?page=1&pageSize=100      // Пагинация (до 25000)
```

### POST /api/works

```javascript
// Создание тенантной работы:
{
  "code": "MY-001",
  "name": "Моя специфическая работа",
  "unit": "шт",
  "basePrice": 1500,
  "isGlobal": false,  // Автоматически добавится tenant_id
  "phase": "Этап №1",
  "section": "Мои работы",
  "subsection": "Специальные"
}

// Создание глобальной (только админ):
{
  "code": "GLOBAL-9999",
  "name": "Новая глобальная работа",
  "unit": "м²",
  "basePrice": 800,
  "isGlobal": true,    // tenant_id = null
  "phase": "Этап №5",
  "section": "Общие",
  "subsection": ""
}
```

---

## 📈 Производительность

### Индексы:

```sql
-- Таблица works:
CREATE INDEX idx_works_is_global ON works(is_global) WHERE is_global = TRUE;
CREATE INDEX idx_works_code ON works(code);
CREATE INDEX idx_works_tenant_id ON works(tenant_id);
CREATE INDEX idx_works_created_at ON works(created_at DESC);

-- Аналогично для materials
```

### Оптимизации:

- ✅ **Кеш отключён** для корректной пагинации
- ✅ **Пагинация:** До 25,000 записей на страницу
- ✅ **Full-text search:** По полям code, name, unit, phase, section, subsection
- ✅ **Сортировка:** `ORDER BY is_global DESC, code ASC` (глобальные первыми)

### Метрики (из логов):

```
[WORKS PERFORMANCE] Query: 660-950ms, Rows: 3371, Params: page=1, pageSize=20000
[WORKS PERFORMANCE] Transform: 1-2ms, Total: ~800ms
```

---

## 🎯 Сценарии использования

### 1. Новый пользователь регистрируется:

```javascript
// При регистрации автоматически:
✅ Доступ к 3,371 глобальным работам
✅ Доступ к 46,976 глобальным материалам
✅ Может создавать свои тенантные записи
✅ Изолирован от других организаций
```

### 2. Организация создаёт свою работу:

```javascript
// UI: Справочник работ → Добавить → Заполнить форму
POST /api/works
{
  "code": "COMPANY-001",
  "name": "Специфическая работа компании",
  "basePrice": 2500,
  "isGlobal": false  // По умолчанию
}

// Результат:
✅ Работа видна только в своей организации
✅ Появляется с меткой 🏢 "Моя"
✅ Можно редактировать/удалять
```

### 3. Экспорт справочника:

```javascript
// Вариант A: Экспорт всех (для анализа)
Фильтр: "Все" → Экспорт
Файл: Экспорт_работ_2025-11-17.csv (3,371 глобальных + N своих)

// Вариант B: Экспорт только своих (для бэкапа)
Фильтр: "Мои" → Экспорт
Файл: Экспорт_работ_мои_2025-11-17.csv (только свои N записей)

// Вариант C: Экспорт глобальных (для обзора)
Фильтр: "Глобальные" → Экспорт
Файл: Экспорт_работ_глобальные_2025-11-17.csv (3,371 запись)
```

### 4. Импорт данных:

```javascript
// Импорт своих работ (добавить к существующим)
Режим: "Добавить"
Файл: Мои_работы_2025.csv
→ Добавляет новые, пропускает дубликаты

// Импорт с полной заменой своих
Режим: "Заменить"
Тип: "Мои"
→ Удаляет все свои → загружает из CSV
⚠️ Глобальные не трогает!

// Импорт глобальных (только для админа)
Режим: "Заменить"
Тип: "Глобальные"
→ Удаляет все глобальные → загружает из CSV
⚠️ Опасная операция! Влияет на все организации.
```

---

## 📚 Файлы документации

```
vite/
├── СПРАВОЧНИКИ_СИСТЕМА.md          ← Этот файл (общая архитектура)
├── CHANGELOG_CSV_IMPORT.md         ← История улучшений CSV
├── CHANGELOG_REMOVE_CATEGORY.md    ← Удаление поля категории
├── export-works-db.mjs             ← Скрипт экспорта работ из БД
├── check-works-structure.mjs       ← Скрипт проверки структуры работ
└── check-materials-structure.mjs   ← Скрипт проверки структуры материалов
```

---

## ✅ Итоги изучения

### Что вы узнали:

1. **Двухуровневая система:**
   - 🌍 Глобальные: 3,371 работ + 46,976 материалов (базовый справочник)
   - 🏢 Тенантные: Пользовательские записи организаций (изолированы)

2. **Фильтрация в UI:**
   - Переключатель: Все / Глобальные / Мои
   - Визуальные индикаторы: badges, иконки
   - Экспорт учитывает выбранный фильтр

3. **Безопасность:**
   - RLS на уровне PostgreSQL
   - Автоматическая изоляция по tenant_id
   - Админские функции защищены проверкой прав

4. **CSV формат:**
   - Разделитель: `;` (semicolon)
   - Без кавычек, с BOM
   - 7 полей для работ (без категории)
   - Иерархия: Фаза → Раздел → Подраздел

5. **API логика:**
   - Параметр `isGlobal` управляет выборкой
   - Автоматическая установка `tenant_id` при создании
   - Pagination до 25,000 записей

### Следующие шаги (опционально):

- [ ] Создать несколько тестовых тенантных работ
- [ ] Протестировать экспорт с фильтром "Мои"
- [ ] Протестировать импорт с режимом "Добавить"
- [ ] Изучить справочник материалов (аналогичная логика)

---

*Документ создан: 17 ноября 2025*  
*Версия системы: v1.17*  
*Всего записей в БД: 50,347 (3,371 работ + 46,976 материалов)*
