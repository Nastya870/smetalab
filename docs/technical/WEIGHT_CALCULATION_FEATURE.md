# ‚ú® FEATURE: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–µ—Å–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Å–º–µ—Ç–µ

**–î–∞—Ç–∞**: 26 –¥–µ–∫–∞–±—Ä—è 2025  
**–ö–æ–º–º–∏—Ç**: acbe6f3  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –æ–±—â–µ–≥–æ –≤–µ—Å–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤** –≤ —Å–º–µ—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –í–µ—Å–∞ –µ–¥–∏–Ω–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ `materials`
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–º–µ—Ç–µ

–§–æ—Ä–º—É–ª–∞: **–û–±—â–∏–π –≤–µ—Å = Œ£ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó –≤–µ—Å –µ–¥–∏–Ω–∏—Ü—ã)** –¥–ª—è –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Å–º–µ—Ç–µ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ú–∏–≥—Ä–∞—Ü–∏—è 053)

**–§–∞–π–ª**: `database/migrations/053_add_weight_to_estimate_materials.sql`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ `estimate_item_materials`:

```sql
-- 1. –ü–æ–ª–µ –¥–ª—è –≤–µ—Å–∞ –µ–¥–∏–Ω–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–∫–≥)
ALTER TABLE estimate_item_materials
ADD COLUMN weight NUMERIC(10, 3) DEFAULT 0;

-- 2. –í—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ –¥–ª—è –æ–±—â–µ–≥–æ –≤–µ—Å–∞
ALTER TABLE estimate_item_materials
ADD COLUMN total_weight NUMERIC(15, 3) 
  GENERATED ALWAYS AS (quantity * weight) STORED;
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Å–∞:

```sql
-- –¢—Ä–∏–≥–≥–µ—Ä –∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ materials –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
CREATE OR REPLACE FUNCTION copy_material_weight()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.weight IS NULL OR NEW.weight = 0 THEN
    SELECT COALESCE(weight, 0) INTO NEW.weight
    FROM materials
    WHERE id = NEW.material_id;
  END IF
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_copy_material_weight
  BEFORE INSERT ON estimate_item_materials
  FOR EACH ROW
  EXECUTE FUNCTION copy_material_weight();
```

#### –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏:

```sql
CREATE VIEW v_estimate_materials_with_weight AS
SELECT 
  eim.id,
  eim.estimate_item_id,
  m.name AS material_name,
  eim.quantity,
  eim.unit_price,
  eim.total_price,
  eim.weight,           -- –í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã (–∫–≥)
  eim.total_weight,     -- –û–±—â–∏–π –≤–µ—Å (–∫–≥)
  m.supplier,
  m.category
FROM estimate_item_materials eim
JOIN materials m ON m.id = eim.material_id;
```

### 2. Backend

**–§–∞–π–ª**: `server/repositories/estimatesRepository.js`

#### –î–æ–±–∞–≤–ª–µ–Ω SELECT –ø–æ–ª–µ–π –≤–µ—Å–∞:

```javascript
// –î–æ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥):
SELECT 
  eim.quantity,
  eim.unit_price,
  eim.total_price,
  m.name as material_name
FROM estimate_item_materials eim
JOIN materials m ON eim.material_id = m.id

// –ü–æ—Å–ª–µ (–Ω–æ–≤—ã–π –∫–æ–¥):
SELECT 
  eim.quantity,
  eim.unit_price,
  eim.total_price,
  eim.weight,        // üî• –î–æ–±–∞–≤–ª–µ–Ω–æ
  eim.total_weight,  // üî• –î–æ–±–∞–≤–ª–µ–Ω–æ
  m.name as material_name
FROM estimate_item_materials eim
JOIN materials m ON eim.material_id = m.id
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–º–µ—Ç—É —Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ—Ç `weight` –∏–∑ `materials`
- `total_weight` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: `quantity √ó weight`
- Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–∞ –ø–æ–ª—è –≤ API –æ—Ç–≤–µ—Ç–µ

### 3. Frontend

**–§–∞–π–ª**: `app/estimates/EstimateWithSidebar.jsx`

#### –†–∞—Å—á—ë—Ç –æ–±—â–µ–≥–æ –≤–µ—Å–∞:

```javascript
const calculateTotals = useMemo(() => {
  let totalWorks = 0;
  let totalMaterials = 0;
  let totalWeight = 0; // üî• –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–¥—Å—á—ë—Ç –≤–µ—Å–∞

  sortedEstimateData.sections.forEach(section => {
    section.items.forEach(item => {
      totalWorks += parseFloat(item.total) || 0;
      
      item.materials?.forEach(material => {
        totalMaterials += parseFloat(material.total) || 0;
        // üî• –ü–æ–¥—Å—á—ë—Ç –≤–µ—Å–∞: quantity √ó weight
        totalWeight += (parseFloat(material.quantity) || 0) * 
                       (parseFloat(material.weight) || 0);
      });
    });
  });

  return {
    totalWorks: totalWorks.toFixed(2),
    totalMaterials: totalMaterials.toFixed(2),
    grandTotal: (totalWorks + totalMaterials).toFixed(2),
    totalWeight: totalWeight.toFixed(3) // üî• –í–µ—Å –≤ –∫–≥ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –≥—Ä–∞–º–º–∞
  };
}, [sortedEstimateData]);
```

#### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏—Ç–æ–≥–∞—Ö:

```jsx
{/* –û–±—â–∏–π –≤–µ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Å > 0 */}
{parseFloat(calculateTotals.totalWeight) > 0 && (
  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>
    <Typography sx={{ fontSize: '0.8125rem', color: '#6B7280' }}>
      –û–±—â–∏–π –≤–µ—Å:
    </Typography>
    <Box sx={{ 
      px: 1.5, 
      py: 0.5, 
      bgcolor: '#EFF6FF',      // –°–∏–Ω–∏–π —Ñ–æ–Ω
      borderRadius: '6px',
      border: '1px solid #BFDBFE'
    }}>
      <Typography sx={{ fontSize: '0.9375rem', fontWeight: 600, color: '#2563EB' }}>
        {parseFloat(calculateTotals.totalWeight).toLocaleString('ru-RU', { 
          minimumFractionDigits: 2, 
          maximumFractionDigits: 3 
        })} –∫–≥
      </Typography>
    </Box>
  </Box>
)}
```

## UI/UX

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ —Å–º–µ—Ç—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ò—Ç–æ–≥–æ –∑–∞ —Ä–∞–±–æ—Ç—ã:         450 000,00 ‚ÇΩ  (–∑–µ–ª—ë–Ω—ã–π –±–µ–π–¥–∂)     ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ –∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:      320 500,00 ‚ÇΩ  (–∂—ë–ª—Ç—ã–π –±–µ–π–¥–∂)      ‚îÇ
‚îÇ  –û–±—â–∏–π –≤–µ—Å:               1 245,750 –∫–≥    (—Å–∏–Ω–∏–π –±–µ–π–¥–∂) üî•   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°—Ç–∏–ª–∏**:
- üü¢ –†–∞–±–æ—Ç—ã: –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω (#F0FDF4), –∑–µ–ª—ë–Ω—ã–π —Ç–µ–∫—Å—Ç (#16A34A)
- üü° –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: –∂—ë–ª—Ç—ã–π —Ñ–æ–Ω (#FEF3C7), –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–µ–∫—Å—Ç (#D97706)
- üîµ –í–µ—Å: —Å–∏–Ω–∏–π —Ñ–æ–Ω (#EFF6FF), —Å–∏–Ω–∏–π —Ç–µ–∫—Å—Ç (#2563EB) ‚Üê **–ù–û–í–û–ï**

**–£—Å–ª–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –ë–µ–π–¥–∂ "–û–±—â–∏–π –≤–µ—Å" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏** —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–∞—Ç–µ—Ä–∏–∞–ª –∏–º–µ–µ—Ç –≤–µ—Å > 0

## –î–∞–Ω–Ω—ã–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `materials`:

```sql
CREATE TABLE materials (
  id SERIAL PRIMARY KEY,
  sku VARCHAR(100) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  unit VARCHAR(50) NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  weight DECIMAL(10, 3),  -- üî• –í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã (–∫–≥)
  supplier VARCHAR(255),
  category VARCHAR(100),
  -- ...
);
```

**–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö**:

| SKU | –ù–∞–∑–≤–∞–Ω–∏–µ | –ï–¥–∏–Ω–∏—Ü–∞ | –¶–µ–Ω–∞ | –í–µ—Å (–∫–≥) |
|-----|----------|---------|------|----------|
| CEM-001 | –¶–µ–º–µ–Ω—Ç –ú500 | –º–µ—à–æ–∫ | 450.00 | 50.000 |
| SAND-002 | –ü–µ—Å–æ–∫ —Ä–µ—á–Ω–æ–π | –º¬≥ | 800.00 | 1600.000 |
| BRICK-003 | –ö–∏—Ä–ø–∏—á –∫—Ä–∞—Å–Ω—ã–π | —à—Ç | 15.00 | 3.500 |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `estimate_item_materials`:

```sql
CREATE TABLE estimate_item_materials (
  id UUID PRIMARY KEY,
  estimate_item_id UUID NOT NULL,
  material_id INTEGER NOT NULL,
  quantity NUMERIC(15, 4),     -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
  unit_price NUMERIC(15, 2),   -- –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
  total_price NUMERIC(15, 2) GENERATED ALWAYS AS (quantity * unit_price) STORED,
  weight NUMERIC(10, 3),       -- üî• –í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã (–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ materials)
  total_weight NUMERIC(15, 3) GENERATED ALWAYS AS (quantity * weight) STORED,  -- üî• –û–±—â–∏–π –≤–µ—Å
  -- ...
);
```

**–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å–º–µ—Ç—ã**:

| –ú–∞—Ç–µ—Ä–∏–∞–ª | –ö–æ–ª-–≤–æ | –í–µ—Å –µ–¥. (–∫–≥) | –û–±—â–∏–π –≤–µ—Å (–∫–≥) | –¶–µ–Ω–∞ |
|----------|--------|--------------|----------------|------|
| –¶–µ–º–µ–Ω—Ç –ú500 | 10 –º–µ—à–∫–æ–≤ | 50.000 | 500.000 | 4 500,00 ‚ÇΩ |
| –ü–µ—Å–æ–∫ —Ä–µ—á–Ω–æ–π | 2 –º¬≥ | 1600.000 | 3200.000 | 1 600,00 ‚ÇΩ |
| –ö–∏—Ä–ø–∏—á | 500 —à—Ç | 3.500 | 1750.000 | 7 500,00 ‚ÇΩ |
| **–ò–¢–û–ì–û** | | | **5450 –∫–≥** | **13 600 ‚ÇΩ** |

## Workflow

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (–æ–¥–∏–Ω —Ä–∞–∑):

```
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Üí –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ‚Üí –ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Üí –°–æ–∑–¥–∞—Ç—å
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ù–∞–∑–≤–∞–Ω–∏–µ: –¶–µ–º–µ–Ω—Ç –ú500           ‚îÇ
‚îÇ –ê—Ä—Ç–∏–∫—É–ª: CEM-001                ‚îÇ
‚îÇ –¶–µ–Ω–∞: 450 ‚ÇΩ                     ‚îÇ
‚îÇ –ï–¥–∏–Ω–∏—Ü–∞: –º–µ—à–æ–∫                  ‚îÇ
‚îÇ –í–µ—Å: 50 –∫–≥  üî•                  ‚îÇ  ‚Üê –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
‚îÇ –ü–æ—Å—Ç–∞–≤—â–∏–∫: –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–º–µ—Ç—É (–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ):

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –°–º–µ—Ç–∞ ‚Üí –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –∫ —Ä–∞–±–æ—Ç–µ ‚Üí –í—ã–±—Ä–∞—Ç—å "–¶–µ–º–µ–Ω—Ç –ú500"
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –¶–µ–º–µ–Ω—Ç –ú500                     ‚îÇ
‚îÇ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 10                  ‚îÇ  ‚Üê –í–≤–æ–¥–∏—Ç—Å—è –≤—Ä—É—á–Ω—É—é
‚îÇ –¶–µ–Ω–∞: 450 ‚ÇΩ                     ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ –í–µ—Å: 50 –∫–≥  üî• (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)  ‚îÇ  ‚Üê –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
‚îÇ –û–±—â–∏–π –≤–µ—Å: 500 –∫–≥ (10 √ó 50)     ‚îÇ  ‚Üê –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è PostgreSQL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Ç–æ–≥–æ–≤:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–º–µ—Ç–∞: –†–µ–º–æ–Ω—Ç –æ—Ñ–∏—Å–∞                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –†–∞–±–æ—Ç–∞ 1: –®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω (50 –º¬≤)          ‚îÇ
‚îÇ   ‚îú‚îÄ –¶–µ–º–µ–Ω—Ç –ú500 √ó 10 –º–µ—à–∫–æ–≤ = 500 –∫–≥      ‚îÇ
‚îÇ   ‚îî‚îÄ –ü–µ—Å–æ–∫ √ó 2 –º¬≥ = 3200 –∫–≥                ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ –†–∞–±–æ—Ç–∞ 2: –ö–ª–∞–¥–∫–∞ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–∫–∏ (20 –º¬≤)       ‚îÇ
‚îÇ   ‚îî‚îÄ –ö–∏—Ä–ø–∏—á √ó 500 —à—Ç = 1750 –∫–≥             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ò—Ç–æ–≥–æ –∑–∞ —Ä–∞–±–æ—Ç—ã:      450 000,00 ‚ÇΩ        ‚îÇ
‚îÇ –ò—Ç–æ–≥–æ –∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:   320 500,00 ‚ÇΩ        ‚îÇ
‚îÇ –û–±—â–∏–π –≤–µ—Å:            5 450,000 –∫–≥  üî•     ‚îÇ  ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### Production (Render PostgreSQL):

```bash
node scripts/apply-migration-053.mjs
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è 053 —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ total_materials ‚îÇ materials_with_weight ‚îÇ total_weight_kg ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 437             ‚îÇ 0                     ‚îÇ 0.00            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: 437 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏–º–µ—é—Ç `weight = 0`, —Ç–∞–∫ –∫–∞–∫ –≤ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–µ—Å –Ω–µ –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω. –ù–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç—å –≤–µ—Å –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: –í–µ—Å –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è (GENERATED ALWAYS) –≤ PostgreSQL
3. **–¢–æ—á–Ω–æ—Å—Ç—å**: Decimal(10, 3) - –¥–æ 1 –≥—Ä–∞–º–º–∞
4. **–£–¥–æ–±—Å—Ç–≤–æ**: –û–¥–∏–Ω —Ä–∞–∑ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤–µ—Å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∑–¥–µ
5. **UX**: –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—â–µ–≥–æ –≤–µ—Å–∞ –≤ –∏—Ç–æ–≥–∞—Ö —Å–º–µ—Ç—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç—á—ë—Ç–∞—Ö

### Excel —ç–∫—Å–ø–æ—Ä—Ç:
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É "–í–µ—Å" –≤ —ç–∫—Å–ø–æ—Ä—Ç —Å–º–µ—Ç—ã
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å "–û–±—â–∏–π –≤–µ—Å" –≤ –∏—Ç–æ–≥–∏

### PDF —ç–∫—Å–ø–æ—Ä—Ç:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–µ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ –ö–°-2, –ö–°-3
- –õ–æ–≥–∏—Å—Ç–∏–∫–∞: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –ø–æ –≤–µ—Å—É

### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
```sql
-- –°–∞–º—ã–µ —Ç—è–∂—ë–ª—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —Å–º–µ—Ç–µ
SELECT 
  material_name,
  SUM(total_weight) as total_kg,
  COUNT(*) as usage_count
FROM v_estimate_materials_with_weight
GROUP BY material_name
ORDER BY total_kg DESC
LIMIT 10;
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. ‚òê –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É "–í–µ—Å" –≤ —Ç–∞–±–ª–∏—Ü—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
2. ‚òê –≠–∫—Å–ø–æ—Ä—Ç –≤–µ—Å–∞ –≤ Excel/PDF
3. ‚òê –§–∏–ª—å—Ç—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –≤–µ—Å—É (>1—Ç, >500–∫–≥ –∏ —Ç.–¥.)
4. ‚òê –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º —Å –ø–æ–¥—Å—á—ë—Ç–æ–º –≤–µ—Å–∞ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏
5. ‚òê –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–±—â–∏–π –≤–µ—Å > X —Ç–æ–Ω–Ω (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞:

1. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ—Ç—É
2. –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º –≤–µ—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¶–µ–º–µ–Ω—Ç –ú500 = 50 –∫–≥)
3. –£–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 10
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∏—Ç–æ–≥–∞—Ö: "–û–±—â–∏–π –≤–µ—Å: 500,000 –∫–≥"

### SQL –ø—Ä–æ–≤–µ—Ä–∫–∞:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞
INSERT INTO estimate_item_materials (
  estimate_item_id, material_id, quantity, unit_price
) VALUES (
  'uuid-of-item', 123, 10, 450
);

-- –í–µ—Å –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–∑ materials
SELECT weight, total_weight 
FROM estimate_item_materials 
WHERE id = 'new-uuid';
-- –û–∂–∏–¥–∞–µ—Ç—Å—è: weight = 50.000, total_weight = 500.000
```

## –ö–æ–º–º–∏—Ç

```bash
git commit -m "‚ú® FEATURE: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–µ—Å–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Å–º–µ—Ç–µ

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–º–∏–≥—Ä–∞—Ü–∏—è 053)**:
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ weight (–≤–µ—Å –µ–¥–∏–Ω–∏—Ü—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ –∫–≥)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ total_weight (quantity √ó weight)
- –¢—Ä–∏–≥–≥–µ—Ä copy_material_weight() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å –∏–∑ materials
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ v_estimate_materials_with_weight –¥–ª—è —É–¥–æ–±–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏

**Backend**:
- estimatesRepository: –¥–æ–±–∞–≤–ª–µ–Ω SELECT weight, total_weight
- –í–µ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–º–µ—Ç—É

**Frontend**:
- EstimateWithSidebar: —Ä–∞—Å—á—ë—Ç –æ–±—â–µ–≥–æ –≤–µ—Å–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ calculateTotals
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ '–û–±—â–∏–π –≤–µ—Å: X.XXX –∫–≥' –≤ –∏—Ç–æ–≥–∞—Ö —Å–º–µ—Ç—ã (—Å–∏–Ω–∏–π –±–µ–π–¥–∂)
- –£—Å–ª–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Å > 0)"
```

---

**–í–µ—Ä—Å–∏—è**: 1.31  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 26 –¥–µ–∫–∞–±—Ä—è 2025, 16:30 MSK
