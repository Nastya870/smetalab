# üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–º–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –±–∞–∑–µ PostgreSQL (Neon).

## üìã –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### 1. **tenants** - –ö–æ–º–ø–∞–Ω–∏–∏ (—Ç–µ–Ω–∞–Ω—Ç—ã)
–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏—è—Ö/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö –≤ —Å–∏—Å—Ç–µ–º–µ.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| name | TEXT | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ |
| plan | TEXT | –¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω (free, basic, premium, enterprise) |
| status | TEXT | –°—Ç–∞—Ç—É—Å (active, suspended, deleted) |
| created_at | TIMESTAMPTZ | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMPTZ | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

#### 2. **users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
–•—Ä–∞–Ω–∏—Ç —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| email | CITEXT | Email (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–Ω) |
| phone | TEXT | –¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| pass_hash | TEXT | –•—ç—à –ø–∞—Ä–æ–ª—è (argon2/bcrypt) |
| full_name | TEXT | –ü–æ–ª–Ω–æ–µ –∏–º—è |
| avatar_url | TEXT | URL –∞–≤–∞—Ç–∞—Ä–∞ |
| status | TEXT | –°—Ç–∞—Ç—É—Å (active, inactive, suspended, deleted) |
| email_verified | BOOLEAN | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ email |
| phone_verified | BOOLEAN | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω |
| last_login_at | TIMESTAMPTZ | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞ |
| created_at | TIMESTAMPTZ | –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ |
| updated_at | TIMESTAMPTZ | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

#### 3. **user_tenants** - –ß–ª–µ–Ω—Å—Ç–≤–æ –≤ –∫–æ–º–ø–∞–Ω–∏–∏
–°–≤—è–∑—å Many-to-Many –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| tenant_id | UUID | FK –Ω–∞ tenants |
| user_id | UUID | FK –Ω–∞ users |
| is_default | BOOLEAN | –ö–æ–º–ø–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| joined_at | TIMESTAMPTZ | –î–∞—Ç–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: (tenant_id, user_id)

#### 4. **roles** - –†–æ–ª–∏
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| key | TEXT | –°–∏—Å—Ç–µ–º–Ω—ã–π –∫–ª—é—á (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| name | TEXT | –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ |
| description | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏ |
| is_system | BOOLEAN | –°–∏—Å—Ç–µ–º–Ω–∞—è —Ä–æ–ª—å (–Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å) |

**–ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏**:
- `super_admin` - –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- `admin` - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏
- `project_manager` - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤
- `estimator` - –°–º–µ—Ç—á–∏–∫
- `supplier` - –ü–æ—Å—Ç–∞–≤—â–∏–∫
- `viewer` - –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å

#### 5. **permissions** - –†–∞–∑—Ä–µ—à–µ–Ω–∏—è
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (permissions).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| key | TEXT | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä. users.create) |
| name | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ |
| description | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ |
| resource | TEXT | –†–µ—Å—É—Ä—Å (users, estimates, projects) |
| action | TEXT | –î–µ–π—Å—Ç–≤–∏–µ (create, read, update, delete, manage) |

#### 6. **role_permissions** - –°–≤—è–∑—å —Ä–æ–ª–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
M2M —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª—è–º.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| role_id | UUID | FK –Ω–∞ roles |
| permission_id | UUID | FK –Ω–∞ permissions |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: (role_id, permission_id)

#### 7. **user_role_assignments** - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| tenant_id | UUID | FK –Ω–∞ tenants |
| user_id | UUID | FK –Ω–∞ users |
| role_id | UUID | FK –Ω–∞ roles |
| assigned_at | TIMESTAMPTZ | –î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è |
| assigned_by | UUID | FK –Ω–∞ users (–∫—Ç–æ –Ω–∞–∑–Ω–∞—á–∏–ª) |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: (tenant_id, user_id, role_id)

#### 8. **sessions** - –°–µ—Å—Å–∏–∏
–•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ refresh-—Ç–æ–∫–µ–Ω–æ–≤.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| user_id | UUID | FK –Ω–∞ users |
| tenant_id | UUID | FK –Ω–∞ tenants (nullable) |
| refresh_token | TEXT | Refresh —Ç–æ–∫–µ–Ω (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| device_info | TEXT | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ |
| ip_address | INET | IP –∞–¥—Ä–µ—Å |
| expires_at | TIMESTAMPTZ | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è |
| created_at | TIMESTAMPTZ | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| last_used_at | TIMESTAMPTZ | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |

#### 9. **email_verifications** - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
–¢–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email –∞–¥—Ä–µ—Å–æ–≤.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| user_id | UUID | FK –Ω–∞ users |
| email | CITEXT | Email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| token | TEXT | –¢–æ–∫–µ–Ω (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| expires_at | TIMESTAMPTZ | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è |
| verified_at | TIMESTAMPTZ | –í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |

#### 10. **password_resets** - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
–¢–æ–∫–µ–Ω—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| user_id | UUID | FK –Ω–∞ users |
| email | CITEXT | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| token | TEXT | –¢–æ–∫–µ–Ω (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| expires_at | TIMESTAMPTZ | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è |
| used_at | TIMESTAMPTZ | –í—Ä–µ–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |

## üîê Row Level Security (RLS)

### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å RLS

#### `current_tenant_id()` ‚Üí UUID
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π tenant_id –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏.

#### `current_user_id()` ‚Üí UUID
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π user_id –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏.

#### `is_super_admin()` ‚Üí BOOLEAN
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º.

#### `is_member_of_tenant(p_tenant_id UUID)` ‚Üí BOOLEAN
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–ª–µ–Ω–æ–º —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.

#### `set_session_context(p_user_id UUID, p_tenant_id UUID)`
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–Ω–∞–Ω—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏.

#### `clear_session_context()`
–û—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏.

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```sql
-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT set_session_context(
    'user-uuid-here'::uuid, 
    'tenant-uuid-here'::uuid
);

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞
SELECT set_session_context('super-admin-uuid-here'::uuid);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
SELECT current_user_id(), current_tenant_id(), is_super_admin();

-- –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
SELECT clear_session_context();
```

## üìä –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)

### `v_active_users_with_tenants`
–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∏—Ö –∫–æ–º–ø–∞–Ω–∏—è–º–∏.

### `v_user_permissions`
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–æ–ª–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd vite
npm install
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `.env` —Å–æ–¥–µ—Ä–∂–∏—Ç:

```env
DATABASE_URL=postgresql://user:password@host:5432/database?sslmode=require
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
node scripts/runMigrations.js
```

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:

1. ‚úÖ –°–æ–∑–¥–∞–¥—É—Ç—Å—è –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
2. ‚úÖ –ó–∞–≥—Ä—É–∑—è—Ç—Å—è –±–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
3. ‚úÖ –°–æ–∑–¥–∞—Å—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—Å—è RLS
5. ‚úÖ –°–æ–∑–¥–∞–¥—É—Ç—Å—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

## üîë –¢–µ—Å—Ç–æ–≤—ã–π —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω:

- **Email**: `admin@smetka.ru`
- **–ü–∞—Ä–æ–ª—å**: `Admin123!`

**‚ö†Ô∏è –í–ê–ñ–ù–û**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞!

## üìù –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏

### SQL –ø—Ä–∏–º–µ—Ä:

```sql
BEGIN;

-- 1. –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–Ω–∏—é
INSERT INTO tenants (name, plan)
VALUES ('–û–û–û "–°—Ç—Ä–æ–π–∫–∞"', 'basic')
RETURNING id; -- tenant_id

-- 2. –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏)
INSERT INTO users (email, pass_hash, full_name, email_verified)
VALUES (
    'admin@stroyka.ru',
    '$2b$10$hashed_password_here',
    '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
    FALSE
)
RETURNING id; -- user_id

-- 3. –°–≤—è–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–º–ø–∞–Ω–∏–µ–π
INSERT INTO user_tenants (tenant_id, user_id, is_default)
VALUES (
    'tenant_id_from_step_1',
    'user_id_from_step_2',
    TRUE
);

-- 4. –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å admin
INSERT INTO user_role_assignments (tenant_id, user_id, role_id)
SELECT 
    'tenant_id_from_step_1',
    'user_id_from_step_2',
    id
FROM roles
WHERE key = 'admin';

COMMIT;
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **bcrypt** –∏–ª–∏ **argon2** –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 8 —Å–∏–º–≤–æ–ª–æ–≤
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã

### TTL —Ç–æ–∫–µ–Ω–æ–≤

- **Refresh token**: 30 –¥–Ω–µ–π
- **Email verification**: 24 —á–∞—Å–∞
- **Password reset**: 1 —á–∞—Å

### –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- ‚úÖ `users.email` - —É–Ω–∏–∫–∞–ª–µ–Ω
- ‚úÖ `users.phone` - —É–Ω–∏–∫–∞–ª–µ–Ω (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
- ‚úÖ `sessions.refresh_token` - —É–Ω–∏–∫–∞–ª–µ–Ω
- ‚úÖ `(tenant_id, user_id)` - —É–Ω–∏–∫–∞–ª—å–Ω–∞ –ø–∞—Ä–∞

## üìà –ò–Ω–¥–µ–∫—Å—ã

–°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

- `users`: email, phone, status, created_at
- `user_tenants`: user_id, tenant_id, (user_id, is_default)
- `user_role_assignments`: user_id, (tenant_id, user_id), role_id
- `sessions`: user_id, tenant_id, expires_at, refresh_token
- –ò –¥—Ä—É–≥–∏–µ...

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `004_your_migration_name.sql` –≤ `database/migrations/`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `node scripts/runMigrations.js`

## üõ† –ü–æ–ª–µ–∑–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
SELECT * FROM v_user_permissions
WHERE user_id = 'user-uuid-here'
  AND tenant_id = 'tenant-uuid-here';
```

### –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
SELECT * FROM sessions
WHERE user_id = 'user-uuid-here'
  AND expires_at > NOW()
ORDER BY last_used_at DESC;
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Å –∏—Ö —Ä–æ–ª—è–º–∏

```sql
SELECT 
    u.email,
    u.full_name,
    r.name as role_name
FROM users u
JOIN user_role_assignments ura ON u.id = ura.user_id
JOIN roles r ON r.id = ura.role_id
WHERE ura.tenant_id = 'tenant-uuid-here'
  AND u.status = 'active';
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –ë–î –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `DATABASE_URL`
2. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Neon PostgreSQL
3. –ù–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (`uuid-ossp`, `citext`)
4. –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 10 –æ–∫—Ç—è–±—Ä—è 2025 –≥.
