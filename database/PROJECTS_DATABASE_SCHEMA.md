# üìã –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥—É–ª—è "–ü—Ä–æ–µ–∫—Ç—ã"

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 11 –æ–∫—Ç—è–±—Ä—è 2025 –≥.  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 007_create_projects_tables.sql  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ production –ë–î

---

## üéØ –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å "–ü—Ä–æ–µ–∫—Ç—ã" —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ —Å:
- ‚úÖ **–ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–µ–π** –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏—è–º–∏
- ‚úÖ **Row-Level Security (RLS)** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ tenant_id
- ‚úÖ **UUID –≤ –∫–∞—á–µ—Å—Ç–≤–µ ID** –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **–ö–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π** —Å —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ **–ü–æ–ª–Ω—ã–º –∞—É–¥–∏—Ç–æ–º** –∏–∑–º–µ–Ω–µ–Ω–∏–π (created_by, updated_by, timestamps)
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### 1. **PROJECTS** - –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏.

#### –ö–æ–ª–æ–Ω–∫–∏:

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | NULL | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|------|----------|
| **id** | UUID | NO | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (PRIMARY KEY) |
| **tenant_id** | UUID | NO | ID –∫–æ–º–ø–∞–Ω–∏–∏-–≤–ª–∞–¥–µ–ª—å—Ü–∞ (FK ‚Üí tenants.id) |
| **name** | VARCHAR(255) | NO | –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ |
| **object_name** | VARCHAR(255) | NO | –ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ |
| **description** | TEXT | YES | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ |
| **client** | VARCHAR(255) | NO | –ó–∞–∫–∞–∑—á–∏–∫ (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è) |
| **contractor** | VARCHAR(255) | NO | –ü–æ–¥—Ä—è–¥—á–∏–∫ (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è) |
| **address** | TEXT | NO | –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ |
| **start_date** | DATE | NO | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç |
| **end_date** | DATE | NO | –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è |
| **actual_end_date** | DATE | YES | –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è |
| **status** | VARCHAR(50) | NO | –°—Ç–∞—Ç—É—Å: planning, active, completed, on-hold, cancelled |
| **progress** | INTEGER | NO | –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (0-100%) |
| **budget** | DECIMAL(15,2) | YES | –ü–ª–∞–Ω–æ–≤—ã–π –±—é–¥–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞ |
| **actual_cost** | DECIMAL(15,2) | YES | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã |
| **created_by** | UUID | YES | –ö—Ç–æ —Å–æ–∑–¥–∞–ª –ø—Ä–æ–µ–∫—Ç (FK ‚Üí users.id) |
| **updated_by** | UUID | YES | –ö—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –æ–±–Ω–æ–≤–ª—è–ª (FK ‚Üí users.id) |
| **manager_id** | UUID | YES | –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ (FK ‚Üí users.id) |
| **created_at** | TIMESTAMPTZ | NO | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (default: NOW()) |
| **updated_at** | TIMESTAMPTZ | NO | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (auto-update trigger) |

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (Constraints):

```sql
CHECK (progress >= 0 AND progress <= 100)
CHECK (end_date >= start_date)
CHECK (actual_end_date IS NULL OR actual_end_date >= start_date)
CHECK (budget >= 0)
CHECK (actual_cost >= 0)
```

#### –ò–Ω–¥–µ–∫—Å—ã (14 —à—Ç—É–∫):

**Single-column:**
- `idx_projects_tenant_id` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
- `idx_projects_status` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
- `idx_projects_created_by` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_projects_manager_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- `idx_projects_created_at` (DESC) - –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ
- `idx_projects_start_date` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
- `idx_projects_end_date` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è

**Composite:**
- `idx_projects_tenant_status` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—É
- `idx_projects_tenant_created_at` - –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏

**GIN (–ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫):**
- `idx_projects_name_gin` - –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞
- `idx_projects_object_name_gin` - –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ–±—ä–µ–∫—Ç–∞
- `idx_projects_client_gin` - –ø–æ–∏—Å–∫ –ø–æ –∑–∞–∫–∞–∑—á–∏–∫—É
- `idx_projects_contractor_gin` - –ø–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Ä—è–¥—á–∏–∫—É

---

### 2. **PROJECT_TEAM_MEMBERS** - –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞

–•—Ä–∞–Ω–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Ö —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞.

#### –ö–æ–ª–æ–Ω–∫–∏:

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | NULL | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|------|----------|
| **id** | UUID | NO | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ (PRIMARY KEY) |
| **project_id** | UUID | NO | ID –ø—Ä–æ–µ–∫—Ç–∞ (FK ‚Üí projects.id) |
| **user_id** | UUID | NO | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FK ‚Üí users.id) |
| **tenant_id** | UUID | NO | ID –∫–æ–º–ø–∞–Ω–∏–∏ (FK ‚Üí tenants.id) |
| **role** | VARCHAR(100) | NO | –†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ (manager, engineer, estimator, etc.) |
| **responsibilities** | TEXT | YES | –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π —É—á–∞—Å—Ç–Ω–∏–∫–∞ |
| **can_edit** | BOOLEAN | YES | –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç (default: false) |
| **can_view_financials** | BOOLEAN | YES | –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã (default: false) |
| **joined_at** | TIMESTAMPTZ | NO | –î–∞—Ç–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç—É (default: NOW()) |
| **left_at** | TIMESTAMPTZ | YES | –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ (NULL = –∞–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫) |
| **added_by** | UUID | YES | –ö—Ç–æ –¥–æ–±–∞–≤–∏–ª —É—á–∞—Å—Ç–Ω–∏–∫–∞ (FK ‚Üí users.id) |

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

```sql
UNIQUE (project_id, user_id, tenant_id) -- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ —Ä–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ
```

#### –ò–Ω–¥–µ–∫—Å—ã (9 —à—Ç—É–∫):

**Single-column:**
- `idx_team_project_id` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–µ–∫—Ç–∞
- `idx_team_user_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_team_tenant_id` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏
- `idx_team_role` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–æ–ª—è–º
- `idx_team_active` (WHERE left_at IS NULL) - —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏

**Composite:**
- `idx_team_project_user` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–∞—Å—Ç–∏—è
- `idx_team_tenant_project` - –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîí Row Level Security (RLS)

### –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è PROJECTS:

#### 1. **projects_select_policy** (SELECT)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç—ã —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ + —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å–µ.

```sql
USING (
  tenant_id = current_tenant_id() OR    -- –°–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
  is_super_admin()                       -- –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ
)
```

#### 2. **projects_insert_policy** (INSERT)
–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.

```sql
WITH CHECK (
  tenant_id = current_tenant_id() AND    -- –¢–æ–ª—å–∫–æ –≤ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
  created_by = current_user_id()         -- –¢–æ–ª—å–∫–æ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏
)
```

#### 3. **projects_update_policy** (UPDATE)
–ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.

```sql
USING (tenant_id = current_tenant_id() OR is_super_admin())
WITH CHECK (tenant_id = current_tenant_id() OR is_super_admin())
```

#### 4. **projects_delete_policy** (DELETE)
–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.

```sql
USING (tenant_id = current_tenant_id() OR is_super_admin())
```

### –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è PROJECT_TEAM_MEMBERS:

–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ 4 –ø–æ–ª–∏—Ç–∏–∫–∏ (SELECT, INSERT, UPDATE, DELETE) –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### 1. **get_active_project_members(p_project_id UUID)**

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- user_id
- full_name
- email
- role
- can_edit
- joined_at

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
SELECT * FROM get_active_project_members('project-uuid-here');
```

---

### 2. **user_has_project_access(p_user_id UUID, p_project_id UUID)**

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–µ–∫—Ç—É –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–∞–Ω–¥—ã.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** BOOLEAN

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
SELECT user_has_project_access(
  'user-uuid-here',
  'project-uuid-here'
); -- TRUE/FALSE
```

---

### 3. **add_creator_to_team()** (TRIGGER)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥—É –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.

**–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:** AFTER INSERT –Ω–∞ —Ç–∞–±–ª–∏—Ü—É projects

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–∑–¥–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è manager
- can_edit = TRUE
- can_view_financials = TRUE

---

### 4. **update_projects_updated_at()** (TRIGGER)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `updated_at` –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.

**–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:** BEFORE UPDATE –Ω–∞ —Ç–∞–±–ª–∏—Ü—É projects

---

## üëÅÔ∏è –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)

### 1. **v_projects_extended**

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏.

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- `created_by_name` - –§–ò–û —Å–æ–∑–¥–∞—Ç–µ–ª—è
- `created_by_email` - Email —Å–æ–∑–¥–∞—Ç–µ–ª—è
- `manager_name` - –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- `manager_email` - Email –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- `tenant_name` - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
- `tenant_plan` - –¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω –∫–æ–º–ø–∞–Ω–∏–∏
- `days_remaining` - –î–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–≤—ã—á–∏—Å–ª—è–µ–º–æ–µ)
- `is_overdue` - –ü—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ –ø—Ä–æ–µ–∫—Ç (–≤—ã—á–∏—Å–ª—è–µ–º–æ–µ)
- `team_size` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã (–≤—ã—á–∏—Å–ª—è–µ–º–æ–µ)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
SELECT * FROM v_projects_extended
WHERE tenant_id = current_tenant_id()
  AND status = 'active'
ORDER BY days_remaining ASC;
```

---

### 2. **v_active_projects_with_team**

–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö –∫–æ–º–∞–Ω–¥—ã.

**–ü–æ–ª—è:**
- project_id, project_name, status, progress, tenant_id
- user_id, team_role, can_edit
- member_name, member_email

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
SELECT * FROM v_active_projects_with_team
WHERE tenant_id = current_tenant_id()
  AND project_id = 'project-uuid-here';
```

---

## üîÑ –°–≤—è–∑—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

### Foreign Keys:

**projects:**
- `tenant_id` ‚Üí `tenants.id` (ON DELETE CASCADE)
- `created_by` ‚Üí `users.id` (ON DELETE SET NULL)
- `updated_by` ‚Üí `users.id` (ON DELETE SET NULL)
- `manager_id` ‚Üí `users.id` (ON DELETE SET NULL)

**project_team_members:**
- `project_id` ‚Üí `projects.id` (ON DELETE CASCADE)
- `user_id` ‚Üí `users.id` (ON DELETE CASCADE)
- `tenant_id` ‚Üí `tenants.id` (ON DELETE CASCADE)
- `added_by` ‚Üí `users.id` (ON DELETE SET NULL)

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:

```sql
INSERT INTO projects (
  tenant_id,
  name,
  object_name,
  client,
  contractor,
  address,
  start_date,
  end_date,
  status,
  created_by
) VALUES (
  'tenant-uuid',
  '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –ñ–ö',
  '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å "–°–æ–ª–Ω–µ—á–Ω—ã–π"',
  '–û–û–û "–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫"',
  '–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä"',
  '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 1',
  '2025-01-15',
  '2026-12-31',
  'planning',
  'user-uuid'
)
RETURNING *;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∑–¥–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–º–∞–Ω–¥—É –∫–∞–∫ manager.

---

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏:

```sql
SELECT * FROM v_projects_extended
WHERE tenant_id = current_tenant_id()
ORDER BY created_at DESC;
```

---

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∫–æ–º–∞–Ω–¥—É:

```sql
INSERT INTO project_team_members (
  project_id,
  user_id,
  tenant_id,
  role,
  can_edit,
  can_view_financials,
  added_by
) VALUES (
  'project-uuid',
  'user-uuid',
  'tenant-uuid',
  'engineer',
  TRUE,
  FALSE,
  'manager-uuid'
);
```

---

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–µ–∫—Ç–∞:

```sql
SELECT * FROM get_active_project_members('project-uuid-here');
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```sql
SELECT user_has_project_access(
  'user-uuid-here',
  'project-uuid-here'
);
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ

| –≠–ª–µ–º–µ–Ω—Ç | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ |
|---------|------------|
| **–¢–∞–±–ª–∏—Ü—ã** | 2 |
| **–ö–æ–ª–æ–Ω–∫–∏ (projects)** | 20 |
| **–ö–æ–ª–æ–Ω–∫–∏ (project_team_members)** | 11 |
| **–ò–Ω–¥–µ–∫—Å—ã** | 23 |
| **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** | 8 |
| **–§—É–Ω–∫—Ü–∏–∏** | 4 |
| **–¢—Ä–∏–≥–≥–µ—Ä—ã** | 2 |
| **–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)** | 2 |
| **Foreign Keys** | 8 |
| **Check Constraints** | 5 |

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. Backend API
- [ ] –°–æ–∑–¥–∞—Ç—å `server/controllers/projectsController.js`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å RLS
- [ ] –î–æ–±–∞–≤–∏—Ç—å endpoints –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é, –ø–æ–∏—Å–∫, –ø–∞–≥–∏–Ω–∞—Ü–∏—é

### 2. Routes
- [ ] –°–æ–∑–¥–∞—Ç—å `server/routes/projects.js`
- [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ `server/index.js`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 3. Frontend
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `src/api/projects.js` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å localStorage –Ω–∞ API –≤—ã–∑–æ–≤—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è API endpoints
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
node scripts/runProjectsMigration.js
```

### –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
```sql
DROP TABLE IF EXISTS project_team_members CASCADE;
DROP TABLE IF EXISTS projects CASCADE;
DROP FUNCTION IF EXISTS get_active_project_members CASCADE;
DROP FUNCTION IF EXISTS user_has_project_access CASCADE;
DROP FUNCTION IF EXISTS add_creator_to_team CASCADE;
DROP FUNCTION IF EXISTS update_projects_updated_at CASCADE;
DROP VIEW IF EXISTS v_projects_extended CASCADE;
DROP VIEW IF EXISTS v_active_projects_with_team CASCADE;
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- ‚úÖ **–°—Ö–µ–º–∞ –ë–î** - –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è** - 007_create_projects_tables.sql —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** - 8 –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** - 23 –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–¢—Ä–∏–≥–≥–µ—Ä—ã** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤ –∫–æ–º–∞–Ω–¥—É
- ‚úÖ **–§—É–Ω–∫—Ü–∏–∏** - 4 –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ **–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è** - 2 view –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚è≥ **Backend API** - –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- ‚è≥ **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** GitHub Copilot  
**–î–∞—Ç–∞:** 11 –æ–∫—Ç—è–±—Ä—è 2025 –≥.  
**–í–µ—Ä—Å–∏—è:** 1.0
