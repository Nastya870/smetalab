# üí∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã —Ä–∞–±–æ—Ç—ã –≤ —Å–º–µ—Ç–µ

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É —Ä–∞–±–æ—Ç—ã **–ø—Ä—è–º–æ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–º–µ—Ç—ã** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –†–∞–±–æ—Ç.

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –î–≤–∞ —É—Ä–æ–≤–Ω—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω:

1. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –†–∞–±–æ—Ç** (`works.base_price`)
   - –≠—Ç–∞–ª–æ–Ω–Ω–∞—è –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–º–µ—Ç
   - –û–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

2. **–ü–æ–∑–∏—Ü–∏—è –≤ —Å–º–µ—Ç–µ** (`estimate_items.unit_price`)
   - –†–∞–±–æ—á–∞—è —Ü–µ–Ω–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
   - –ú–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–π
   - –ù–µ–∑–∞–≤–∏—Å–∏–º–∞ –æ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

### –°–≤—è–∑—å –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏:

```
works (id, base_price)  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ work_id ‚îÄ‚îÄ‚îÄ‚îÄ  estimate_items (unit_price)
     ‚Üë                                              ‚Üì
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫                                     –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–º–µ—Ç–∞
(—ç—Ç–∞–ª–æ–Ω)                                       (—Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è)
```

## üìù –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –≤ —Å–º–µ—Ç–µ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç —Ü–µ–Ω—É –≤ –∂–µ–ª—Ç–æ–º –ø–æ–ª–µ
2. –ù–∞–∂–∏–º–∞–µ—Ç Enter –∏–ª–∏ —É—Ö–æ–¥–∏—Ç —Å –ø–æ–ª—è (onBlur)
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `total` —Ä–∞–±–æ—Ç—ã: `quantity √ó price`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `estimate_items.unit_price`
5. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è**

```javascript
// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ —Å–º–µ—Ç–µ
handleWorkPriceBlur(sectionIndex, itemIndex, newPrice)
  ‚Üí setEstimateData({ price: newPrice, total: quantity * price })
  ‚Üí API: PUT /api/estimates/:id (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–º–µ—Ç—ã)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç üîÑ (IconRefresh) —Ä—è–¥–æ–º —Å —Ü–µ–Ω–æ–π
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
   ```
   –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –†–∞–±–æ—Ç?
   
   –ù–æ–≤–∞—è —Ü–µ–Ω–∞: 194 ‚ÇΩ
   
   ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –∏–∑–º–µ–Ω–∏—Ç –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É —Ä–∞–±–æ—Ç—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ.
   –í—Å–µ –Ω–æ–≤—ã–µ —Å–º–µ—Ç—ã –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é —Ü–µ–Ω—É.
   ```
3. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è API: `PATCH /api/works/:id/price`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `works.base_price` –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
5. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–º–µ—Ç—ã –ù–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è**

```javascript
handleUpdateWorkPriceInReference(workId, currentPrice)
  ‚Üí window.confirm() ‚Üí OK
  ‚Üí API: PATCH /api/works/:workId/price { basePrice: 194 }
  ‚Üí UPDATE works SET base_price = 194 WHERE id = workId
```

## üñºÔ∏è –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

### –¶–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã (–∂–µ–ª—Ç—ã–π —Ñ–æ–Ω):
```jsx
<TextField 
  defaultValue={item.price}
  sx={{ bgcolor: '#FEF3C7' }}  // –ñ–µ–ª—Ç—ã–π = —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
/>
```

### –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:
```jsx
{item.workId && (
  <Tooltip title="–û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –†–∞–±–æ—Ç">
    <IconButton onClick={() => onUpdateWorkPrice(workId, price)}>
      <IconRefresh />
    </IconButton>
  </Tooltip>
)}
```

## üîê –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –≤ —Å–º–µ—Ç–µ:
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∞–≤–æ `estimates.update` –∏–ª–∏ `estimates.manage`

### –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ:
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∞–≤–æ `works.update` –∏–ª–∏ `works.manage`
- Tenant Isolation: –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç—ã —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã: —Ç–æ–ª—å–∫–æ `super_admin`

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è —Ü–µ–Ω–∞

**–°–∏—Ç—É–∞—Ü–∏—è:** –ü–æ–¥—Ä—è–¥—á–∏–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª —Ü–µ–Ω—É 194 ‚ÇΩ –≤–º–µ—Å—Ç–æ –±–∞–∑–æ–≤–æ–π 150 ‚ÇΩ

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–º–µ—Ç—É
2. –ú–µ–Ω—è–µ–º —Ü–µ–Ω—É —Ä–∞–±–æ—Ç—ã —Å 150 –Ω–∞ 194
3. –ù–∞–∂–∏–º–∞–µ–º Enter
4. ‚úÖ Total –ø–µ—Ä–µ—Å—á–∏—Ç–∞–ª—Å—è: `10 –º¬≤ √ó 194 ‚ÇΩ = 1940 ‚ÇΩ`
5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–º–µ—Ç—É
6. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—Å—Ç–∞–ª—Å—è 150 ‚ÇΩ** (–¥—Ä—É–≥–∏–µ —Å–º–µ—Ç—ã –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã)

### –ü—Ä–∏–º–µ—Ä 2: –†–æ—Å—Ç —Ü–µ–Ω –Ω–∞ —Ä—ã–Ω–∫–µ

**–°–∏—Ç—É–∞—Ü–∏—è:** –¶–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã –≤—ã—Ä–æ—Å–ª–∞ —Å 150 –¥–æ 180 ‚ÇΩ, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–º–µ—Ç—É —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π 180 ‚ÇΩ
2. –ù–∞–∂–∏–º–∞–µ–º üîÑ —Ä—è–¥–æ–º —Å —Ü–µ–Ω–æ–π
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –¥–∏–∞–ª–æ–≥
4. ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω: `base_price = 180 ‚ÇΩ`
5. **–ù–æ–≤—ã–µ —Å–º–µ—Ç—ã** –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 180 ‚ÇΩ
6. **–°—Ç–∞—Ä—ã–µ —Å–º–µ—Ç—ã** –æ—Å—Ç–∞–ª–∏—Å—å —Å –ø—Ä–µ–∂–Ω–∏–º–∏ —Ü–µ–Ω–∞–º–∏

## üîß API Endpoints

### PATCH /api/works/:id/price

**Request:**
```json
{
  "basePrice": 180.00
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã \"–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω\" –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ 180 ‚ÇΩ",
  "data": {
    "id": 123,
    "code": "2-170",
    "name": "–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω",
    "base_price": 180.00,
    "updated_at": "2025-12-25T10:30:00Z"
  }
}
```

**Response (Error - No Permission):**
```json
{
  "success": false,
  "message": "–¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
}
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ù–ï –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `base_price` –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ **–Ω–æ–≤—ã–µ** —Å–º–µ—Ç—ã
- –°—Ç–∞—Ä—ã–µ —Å–º–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–≤–æ–∏ —Ü–µ–Ω—ã

### 2. –ê–≤—Ç–æ–ø–µ—Ä–µ—Å—á–µ—Ç
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `total`
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è (—Ç–æ–ª—å–∫–æ total —Ä–∞–±–æ—Ç—ã)

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –¶–µ–Ω–∞ –≤ —Å–º–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–º–µ—Ç—ã
- –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ API

### 4. Tenant Isolation
- –ö–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–∞–±–æ—Ç—ã
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –≤–∏–¥–Ω—ã –≤—Å–µ–º, –Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ super_admin

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ —Å–º–µ—Ç–µ:**
   ```
   –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ—Ç—É ‚Üí –ù–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É ‚Üí –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É ‚Üí Enter
   ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç total ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º–µ—Ç—É
   ```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:**
   ```
   –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É ‚Üí –ù–∞–∂–∞—Ç—å üîÑ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
   ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –†–∞–±–æ—Ç (base_price –∏–∑–º–µ–Ω–∏–ª—Å—è)
   ‚Üí –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–º–µ—Ç—É ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–Ω—É (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–æ–≤–∞—è)
   ```

3. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
   ```
   –í–æ–π—Ç–∏ –∫–∞–∫ estimator ‚Üí –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É
   ‚Üí –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 403
   ```

## üìÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2025-12-25**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã —Ä–∞–±–æ—Ç—ã
- –î–æ–±–∞–≤–ª–µ–Ω API endpoint `PATCH /api/works/:id/price`
- –î–æ–±–∞–≤–ª–µ–Ω –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**Frontend:**
- `app/estimates/components/WorkRow.jsx` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç—Ä–æ–∫–∏ —Ä–∞–±–æ—Ç—ã
- `app/estimates/EstimateWithSidebar.jsx` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
- `shared/lib/api/works.js` - API –∫–ª–∏–µ–Ω—Ç

**Backend:**
- `server/routes/works.js` - —Ä–æ—É—Ç—ã
- `server/controllers/worksController.js` - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä updateWorkPrice
- `database/migrations/003_create_works_table.sql` - —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã works
