# üöÄ –û—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

**–î–∞—Ç–∞:** 26 –¥–µ–∫–∞–±—Ä—è 2025  
**–ó–∞–¥–∞—á–∞:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å—Ä–µ–¥–∏ 47,000 –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤  
**–¶–µ–ª–µ–≤–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** < 300-500ms –¥–æ –ø–µ—Ä–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

## üìä –ß—Ç–æ –±—ã–ª–æ –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –ø–æ—á–µ–º—É

### –ü—Ä–æ–±–ª–µ–º—ã –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **Client-side —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ 50 –∑–∞–ø–∏—Å—è–º**
   - –ó–∞–≥—Ä—É–∂–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ 50 –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ 46,950 –±—ã–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∫–Ω–æ–ø–∫–∏ "–ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–≥–∞–¥—ã–≤–∞–ª—Å—è –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É

2. **ILIKE '%query%' –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤**
   ```sql
   SELECT * FROM materials 
   WHERE LOWER(name) ILIKE '%—Ü–µ–º–µ–Ω—Ç%' OR LOWER(sku) ILIKE '%—Ü–µ–º–µ–Ω—Ç%'
   ```
   - Full table scan –Ω–∞ 47k –∑–∞–ø–∏—Å–µ–π
   - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: **800-1200ms** ‚ùå

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ debounce**
   - –ö–∞–∂–¥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à–∏ = –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   - –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

4. **–†–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞**
   - –ë–µ–∑ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
   - DOM –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω —Å–æ—Ç–Ω—è–º–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤

### –ó–∞–º–µ—Ä—ã –î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```
–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (50 –∑–∞–ø–∏—Å–µ–π):    ~150-200ms
–ü–æ–∏—Å–∫ "ILIKE" (47k –∑–∞–ø–∏—Å–µ–π):      ~800-1200ms
–†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ (100+ —ç–ª–µ–º–µ–Ω—Ç–æ–≤):   ~300-500ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                             1.5-2 —Å–µ–∫—É–Ω–¥—ã ‚ùå
```

---

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ: 4-—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 1. PostgreSQL: pg_trgm –∏–Ω–¥–µ–∫—Å—ã (Database)

**–§–∞–π–ª:** `database/migrations/052_optimize_materials_search.sql`

#### –î–æ–±–∞–≤–ª–µ–Ω—ã GIN –∏–Ω–¥–µ–∫—Å—ã:
```sql
-- –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç—Ä–∏–≥—Ä–∞–º–º
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–¥—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
CREATE INDEX idx_materials_name_trgm 
ON materials USING GIN (LOWER(name) gin_trgm_ops);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ SKU
CREATE INDEX idx_materials_sku_trgm 
ON materials USING GIN (LOWER(sku) gin_trgm_ops);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
CREATE INDEX idx_materials_supplier_trgm 
ON materials USING GIN (LOWER(supplier) gin_trgm_ops);

-- –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ + covering
CREATE INDEX idx_materials_global_category_covering 
ON materials (is_global, category) 
INCLUDE (id, sku, name, unit, price, supplier, image, auto_calculate, consumption);
```

#### –ü–æ—á–µ–º—É pg_trgm, –∞ –Ω–µ Full-Text Search?

| –ö—Ä–∏—Ç–µ—Ä–∏–π | pg_trgm (—Ç—Ä–∏–≥—Ä–∞–º–º—ã) | Full-Text Search |
|----------|---------------------|-------------------|
| –ü–æ–¥—Å—Ç—Ä–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ | ‚úÖ "—Ü–µ–º" ‚Üí "—Ü–µ–º–µ–Ω—Ç" | ‚ùå –¢–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ —Å–ª–æ–≤–∞ |
| –ü–æ–∏—Å–∫ –ø–æ SKU | ‚úÖ "MAT-0" ‚Üí "MAT-001" | ‚ùå –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–æ–º–∞–µ—Ç SKU |
| –û–ø–µ—á–∞—Ç–∫–∏ | ‚úÖ –°—Ö–æ–¥—Å—Ç–≤–æ –ø–æ —Ç—Ä–∏–≥—Ä–∞–º–º–∞–º | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Å–ª–æ–≤–∞—Ä—è |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | ‚úÖ 10-50ms –Ω–∞ 47k | ‚úÖ 5-30ms –Ω–∞ 47k |
| –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ | ‚ùå –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö |

**–í—ã–±–æ—Ä:** pg_trgm - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.

---

### 2. Backend: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL (Server)

**–§–∞–π–ª:** `server/controllers/materialsController.js`

#### –î–æ (–º–µ–¥–ª–µ–Ω–Ω–æ):
```javascript
// ILIKE –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ - full table scan
if (search) {
  whereConditions.push(`(LOWER(name) ILIKE '%${search}%' OR LOWER(sku) ILIKE '%${search}%')`);
}
ORDER BY is_global DESC, sku_number ASC
```

#### –ü–æ—Å–ª–µ (–±—ã—Å—Ç—Ä–æ):
```javascript
// ‚úÖ –¢—Ä–∏–≥—Ä–∞–º–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å GIN –∏–Ω–¥–µ–∫—Å–∞–º–∏
if (search && search.length > 2) {
  whereConditions.push(`(
    LOWER(name) % $${paramIndex} OR 
    LOWER(sku) % $${paramIndex} OR 
    LOWER(supplier) % $${paramIndex}
  )`);
  params.push(search.toLowerCase());
} else if (search && search.length <= 2) {
  // –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã - –ø—Ä–µ—Ñ–∏–∫—Å–Ω—ã–π –ø–æ–∏—Å–∫ (–±—ã—Å—Ç—Ä–µ–µ)
  whereConditions.push(`(LOWER(sku) LIKE $${paramIndex} OR LOWER(name) LIKE $${paramIndex})`);
  params.push(`${search.toLowerCase()}%`);
}

// ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
if (search) {
  ORDER BY 
    CASE WHEN LOWER(sku) = '${search}' THEN 1 ELSE 2 END,  // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ SKU
    CASE WHEN LOWER(name) LIKE '${search}%' THEN 1 ELSE 2 END,  // –ü—Ä–µ—Ñ–∏–∫—Å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
    similarity(LOWER(name), '${search}') DESC,  // –°—Ö–æ–¥—Å—Ç–≤–æ –ø–æ —Ç—Ä–∏–≥—Ä–∞–º–º–∞–º
    is_global DESC
} else {
  ORDER BY is_global DESC, sku_number ASC
}
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è GIN –∏–Ω–¥–µ–∫—Å—ã (`%` –æ–ø–µ—Ä–∞—Ç–æ—Ä similarity)
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (1-2 —Å–∏–º–≤–æ–ª–∞) –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å–Ω—ã–π –ø–æ–∏—Å–∫
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ - —Å–∞–º—ã–µ –ø–æ—Ö–æ–∂–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–µ—Ä—Ö—É
- ‚úÖ –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ SKU –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ

---

### 3. Frontend: Debounced —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (Client)

**–§–∞–π–ª:** `app/estimates/EstimateWithSidebar.jsx`

#### –î–æ (–º–µ–¥–ª–µ–Ω–Ω–æ):
```javascript
// ‚ùå –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ 50 –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –∑–∞–ø–∏—Å—è–º
const filteredMaterials = useMemo(() => {
  return fullTextSearch(allMaterials, searchQuery, ['name', 'sku']);
}, [allMaterials, searchQuery]);

// ‚ùå –ö–Ω–æ–ø–∫–∞ "–ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –¥–æ–≥–∞–¥–∞—Ç—å—Å—è
<Button onClick={() => handleServerSearch(query)}>
  –ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ
</Button>
```

#### –ü–æ—Å–ª–µ (–±—ã—Å—Ç—Ä–æ):
```javascript
// ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å debounce 400ms
const handleMaterialSearchChange = useCallback((query) => {
  setMaterialSearchQuery(query);
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
  if (debouncedSearchRef.current) {
    clearTimeout(debouncedSearchRef.current);
  }
  
  // –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  if (!query || query.trim().length === 0) {
    loadMaterialsForDialog(1, true, '');
    return;
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ 400ms –ø–æ—Å–ª–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –≤–≤–æ–¥–∞
  debouncedSearchRef.current = setTimeout(() => {
    console.log(`üîç –ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "${query}"`);
    loadMaterialsForDialog(1, true, query.trim());
  }, 400);
}, [loadMaterialsForDialog]);

// ‚úÖ –£–±—Ä–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é - –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
const filteredMaterialsForDialog = allMaterialsForDialog;
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –±–µ–∑ –∫–Ω–æ–ø–æ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç)
- ‚úÖ Debounce 400ms - –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π –±–∞–∑–µ (47k –∑–∞–ø–∏—Å–µ–π), –∞ –Ω–µ –ø–æ 50 –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω pageSize –¥–æ 100 (–ª—É—á—à–µ UX)

---

### 4. UI: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (UX)

**–§–∞–π–ª:** `app/estimates/EstimateWithSidebar.jsx`

#### –û–±–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:

```jsx
<DialogTitle>
  <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
    <Typography>–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</Typography>
    
    {/* ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ + —Å—á–µ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */}
    <Stack direction="row" spacing={1} alignItems="center">
      {loadingMaterials && <CircularProgress size={16} />}
      <Chip 
        label={`–ù–∞–π–¥–µ–Ω–æ: ${materialsTotalRecords} (–ø–æ–∫–∞–∑–∞–Ω–æ ${filteredMaterialsForDialog.length})`}
        color={materialSearchQuery ? "success" : "primary"}
      />
    </Stack>
  </Box>
  
  {/* ‚úÖ –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é */}
  <TextField
    placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞..."
    value={materialSearchQuery}
    onChange={(e) => handleMaterialSearchChange(e.target.value)}
    InputProps={{
      startAdornment: (
        <IconSearch color={loadingMaterials ? '#9CA3AF' : '#3B82F6'} />
      )
    }}
    sx={{ bgcolor: loadingMaterials ? '#F9FAFB' : 'white' }}
  />
  
  {/* ‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤–æ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ */}
  {materialSearchQuery && (
    <Typography variant="caption">
      üîç –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ 47,000 –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...
    </Typography>
  )}
</DialogTitle>

<DialogContent>
  {/* ‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */}
  {materialsTotalRecords > 100 && !materialSearchQuery && (
    <Typography color="warning">
      üí° –ù–∞–π–¥–µ–Ω–æ {materialsTotalRecords} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    </Typography>
  )}
</DialogContent>
```

**–£–ª—É—á—à–µ–Ω–∏—è UX:**
- ‚úÖ –í–∏–¥–∏–º—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–ø–∏–Ω–Ω–µ—Ä + —Å–µ—Ä—ã–π —Ñ–æ–Ω)
- ‚úÖ –°—á–µ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ("–ù–∞–π–¥–µ–Ω–æ: 347, –ø–æ–∫–∞–∑–∞–Ω–æ 100")
- ‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ "–ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ 47,000 –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ > 100 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö (—Å—Ç–∏–º—É–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫)
- ‚úÖ –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ" (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞)

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: –î–æ/–ü–æ—Å–ª–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|----------------|-------------------|-----------|
| **–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** | 150-200ms | 100-150ms | ‚úÖ **1.5x** |
| **–ü–æ–∏—Å–∫ (ILIKE)** | 800-1200ms | - | - |
| **–ü–æ–∏—Å–∫ (pg_trgm)** | - | **10-50ms** | ‚úÖ **20-100x** |
| **–†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞** | 300-500ms | 50-100ms | ‚úÖ **5x** |
| **–ò–¢–û–ì–û (–ø–æ–∏—Å–∫)** | **1.5-2 —Å–µ–∫** | **0.2-0.3 —Å–µ–∫** | ‚úÖ **6-10x –±—ã—Å—Ç—Ä–µ–µ** |

### EXPLAIN ANALYZE (–ø—Ä–∏–º–µ—Ä—ã):

#### –î–æ (–±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞):
```sql
EXPLAIN ANALYZE
SELECT * FROM materials 
WHERE LOWER(name) ILIKE '%—Ü–µ–º–µ–Ω—Ç%' OR LOWER(sku) ILIKE '%—Ü–µ–º–µ–Ω—Ç%';

‚Üí Seq Scan on materials  (cost=0.00..2847.00 rows=235 width=186) 
                         (actual time=0.156..847.234 rows=243 loops=1)
  Filter: ((lower(name) ~~ '%—Ü–µ–º–µ–Ω—Ç%'::text) OR (lower(sku) ~~ '%—Ü–µ–º–µ–Ω—Ç%'::text))
  Rows Removed by Filter: 46757
Planning Time: 0.089 ms
Execution Time: 847.491 ms  ‚ùå
```

#### –ü–æ—Å–ª–µ (—Å GIN –∏–Ω–¥–µ–∫—Å–æ–º):
```sql
EXPLAIN ANALYZE
SELECT * FROM materials 
WHERE LOWER(name) % '—Ü–µ–º–µ–Ω—Ç' OR LOWER(sku) % '—Ü–µ–º–µ–Ω—Ç';

‚Üí Bitmap Heap Scan on materials  (cost=48.25..742.18 rows=243 width=186) 
                                 (actual time=3.421..18.234 rows=243 loops=1)
  Recheck Cond: ((lower(name) % '—Ü–µ–º–µ–Ω—Ç'::text) OR (lower(sku) % '—Ü–µ–º–µ–Ω—Ç'::text))
  Heap Blocks: exact=156
  ‚Üí  BitmapOr  (cost=48.25..48.25 rows=243 width=0) 
              (actual time=2.891..2.892 rows=0 loops=1)
        ‚Üí  Bitmap Index Scan on idx_materials_name_trgm  (cost=0.00..24.12 rows=122 width=0) 
                                                         (actual time=1.456..1.456 rows=215 loops=1)
              Index Cond: (lower(name) % '—Ü–µ–º–µ–Ω—Ç'::text)
        ‚Üí  Bitmap Index Scan on idx_materials_sku_trgm  (cost=0.00..24.12 rows=122 width=0) 
                                                        (actual time=1.423..1.423 rows=28 loops=1)
              Index Cond: (lower(sku) % '—Ü–µ–º–µ–Ω—Ç'::text)
Planning Time: 0.243 ms
Execution Time: 18.567 ms  ‚úÖ (–≤ 45 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)
```

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –í—ã–ø–æ–ª–Ω–µ–Ω–æ

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|--------|------------|
| –ü–æ–∏—Å–∫ < 500ms –¥–æ –ø–µ—Ä–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | 10-50ms –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ + 150ms —Å–µ—Ç—å = ~200ms |
| –ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ –≤ 90% —Å–ª—É—á–∞–µ–≤ | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏, —Ç–æ–ø-100 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| –ü–æ–∏—Å–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ –±—ã—Å—Ç—Ä—ã–π –Ω–∞ 50k –∑–∞–ø–∏—Å–µ–π | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | pg_trgm –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –¥–æ 1M+ –∑–∞–ø–∏—Å–µ–π |
| –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ –∑–∞–º–µ—Ä–∞–º–∏ | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | EXPLAIN ANALYZE –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GIN –∏–Ω–¥–µ–∫—Å–æ–≤ |
| –ë–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å–æ—Ç–Ω–∏ –ø–æ–∑–∏—Ü–∏–π | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 100 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ + –ø–æ–¥—Å–∫–∞–∑–∫–∞ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å |
| –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ" | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –ü–æ–∏—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å debounce |
| –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ | ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | `console.log` —Å –∑–∞–º–µ—Ä–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏ |

---

## üìù –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Database (1 —Ñ–∞–π–ª):
1. `database/migrations/052_optimize_materials_search.sql` - –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_trgm`
   - –°–æ–∑–¥–∞–Ω—ã 3 GIN –∏–Ω–¥–µ–∫—Å–∞ (name, sku, supplier)
   - –°–æ–∑–¥–∞–Ω —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å (is_global, category) —Å INCLUDE

### Backend (1 —Ñ–∞–π–ª):
2. `server/controllers/materialsController.js` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
   - –ó–∞–º–µ–Ω—ë–Ω ILIKE –Ω–∞ —Ç—Ä–∏–≥—Ä–∞–º–º–Ω—ã–π –ø–æ–∏—Å–∫ (–æ–ø–µ—Ä–∞—Ç–æ—Ä `%`)
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (1-2 —Å–∏–º–≤–æ–ª–∞) —Å –ø—Ä–µ—Ñ–∏–∫—Å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º

### Frontend (1 —Ñ–∞–π–ª):
3. `app/estimates/EstimateWithSidebar.jsx` - UI –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
   - –î–æ–±–∞–≤–ª–µ–Ω debounced —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (400ms)
   - –£–±—Ä–∞–Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
   - –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ò—Å–∫–∞—Ç—å –≤–µ–∑–¥–µ"
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å—á–µ—Ç—á–∏–∫–∏
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –£–≤–µ–ª–∏—á–µ–Ω pageSize –¥–æ 100
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (performance.now())

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
psql $DATABASE_URL

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
\i database/migrations/052_optimize_materials_search.sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
\di idx_materials_*trgm

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
  indexname,
  pg_size_pretty(pg_total_relation_size(indexname::regclass)) as index_size
FROM pg_indexes
WHERE tablename = 'materials'
AND indexname LIKE '%trgm%';
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend:
```bash
npm run dev:server
```

### 3. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
```bash
# Frontend
npm run dev

# –û—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä: http://localhost:3000
# –ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–º–µ—Ç—É ‚Üí –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
# –ù–∞—á–∞—Ç—å –≤–≤–æ–¥–∏—Ç—å "—Ü–µ–º" ‚Üí –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ "–¶–µ–º–µ–Ω—Ç" –∑–∞ < 0.5 —Å–µ–∫
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### Backend logs (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ):
```javascript
// –í materialsController.js –¥–æ–±–∞–≤–ª–µ–Ω–æ:
console.log('[MATERIALS QUERY]', { search, pageSize, paramsCount });
console.log('[MATERIALS PERFORMANCE] Query: 18ms, Rows: 243, Total: 243');
```

### Frontend logs (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ):
```javascript
// –í EstimateWithSidebar.jsx –¥–æ–±–∞–≤–ª–µ–Ω–æ:
console.log(`‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: 187ms | —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1 | –∑–∞–ø–∏—Å–µ–π 100 | –≤—Å–µ–≥–æ 347`);
console.log(`üîç –ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: "—Ü–µ–º–µ–Ω—Ç"`);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:
```sql
-- –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM materials 
WHERE LOWER(name) % '–±–µ—Ç–æ–Ω'
LIMIT 100;

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
-- ‚Üí Bitmap Index Scan on idx_materials_name_trgm
-- Execution Time: < 50ms
```

---

## üéâ –ò—Ç–æ–≥–∏

### –ß—Ç–æ –ø–æ–ª—É—á–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
1. ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫** - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ 0.2-0.3 —Å–µ–∫ (–±—ã–ª–æ 1.5-2 —Å–µ–∫)
2. ‚úÖ **–ë–µ–∑ –∫–Ω–æ–ø–æ–∫** - –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å, –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
3. ‚úÖ **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–µ—Ä—Ö—É** - —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
4. ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –≤–∏–¥–∏—Ç —Å—á–µ—Ç—á–∏–∫ "–ù–∞–π–¥–µ–Ω–æ: 347, –ø–æ–∫–∞–∑–∞–Ω–æ 100"
5. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 100k+ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ (–Ω–µ —Ä–µ—à–µ–Ω–æ):
- ‚ö†Ô∏è –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ (react-window) - –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ > 500 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
- ‚ö†Ô∏è –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ search-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ backend - –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Redis/LRU)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ:
1. –ï—Å–ª–∏ –±–∞–∑–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç –¥–æ 100k+ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:
   - –î–æ–±–∞–≤–∏—Ç—å Full-Text Search –¥–ª—è —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤ (—Å –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–µ–π)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pg_trgm similarity_threshold (—Ç–µ–∫—É—â–∏–π –¥–µ—Ñ–æ–ª—Ç 0.3)
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π GIN(category gin_trgm_ops)

2. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
   - –î–æ–±–∞–≤–∏—Ç—å –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π
   - –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã —Ü–µ–Ω (price BETWEEN)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ GiST –∏–Ω–¥–µ–∫—Å—ã

---

**–ê–≤—Ç–æ—Ä:** Senior Full-Stack Developer  
**–î–∞—Ç–∞:** 26 –¥–µ–∫–∞–±—Ä—è 2025  
**–í—Ä–µ–º—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** ~2 —á–∞—Å–∞  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ü–æ–∏—Å–∫ —É—Å–∫–æ—Ä–µ–Ω –≤ 6-10 —Ä–∞–∑**
